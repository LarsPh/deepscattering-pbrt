/*
    pbrt source code is Copyright(c) 1998-2016
                        Matt Pharr, Greg Humphreys, and Wenzel Jakob.

    This file is part of pbrt.

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions are
    met:

    - Redistributions of source code must retain the above copyright
      notice, this list of conditions and the following disclaimer.

    - Redistributions in binary form must reproduce the above copyright
      notice, this list of conditions and the following disclaimer in the
      documentation and/or other materials provided with the distribution.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
    IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
    TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
    PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

 */

// core/medium.cpp*
#include "medium.h"

#include "interaction.h"
#include "memory.h"
#include "pbrt.h"
#include "sampler.h"
#include "stats.h"

namespace pbrt {
// Media Local Definitions
struct MeasuredSS {
    const char *name;
    Float sigma_prime_s[3], sigma_a[3];  // mm^-1
};

static MeasuredSS SubsurfaceParameterTable[] = {
    // From "A Practical Model for Subsurface Light Transport"
    // Jensen, Marschner, Levoy, Hanrahan
    // Proc SIGGRAPH 2001
    {
        "Apple",
        {2.29, 2.39, 1.97},
        {0.0030, 0.0034, 0.046},
    },
    {
        "Chicken1",
        {0.15, 0.21, 0.38},
        {0.015, 0.077, 0.19},
    },
    {
        "Chicken2",
        {0.19, 0.25, 0.32},
        {0.018, 0.088, 0.20},
    },
    {
        "Cream",
        {7.38, 5.47, 3.15},
        {0.0002, 0.0028, 0.0163},
    },
    {
        "Ketchup",
        {0.18, 0.07, 0.03},
        {0.061, 0.97, 1.45},
    },
    {
        "Marble",
        {2.19, 2.62, 3.00},
        {0.0021, 0.0041, 0.0071},
    },
    {
        "Potato",
        {0.68, 0.70, 0.55},
        {0.0024, 0.0090, 0.12},
    },
    {
        "Skimmilk",
        {0.70, 1.22, 1.90},
        {0.0014, 0.0025, 0.0142},
    },
    {
        "Skin1",
        {0.74, 0.88, 1.01},
        {0.032, 0.17, 0.48},
    },
    {
        "Skin2",
        {1.09, 1.59, 1.79},
        {0.013, 0.070, 0.145},
    },
    {
        "Spectralon",
        {11.6, 20.4, 14.9},
        {0.00, 0.00, 0.00},
    },
    {
        "Wholemilk",
        {2.55, 3.21, 3.77},
        {0.0011, 0.0024, 0.014},
    },

    // From "Acquiring Scattering Properties of Participating Media by
    // Dilution",
    // Narasimhan, Gupta, Donner, Ramamoorthi, Nayar, Jensen
    // Proc SIGGRAPH 2006
    {"Lowfat Milk", {0.89187, 1.5136, 2.532}, {0.002875, 0.00575, 0.0115}},
    {"Reduced Milk",
     {2.4858, 3.1669, 4.5214},
     {0.0025556, 0.0051111, 0.012778}},
    {"Regular Milk", {4.5513, 5.8294, 7.136}, {0.0015333, 0.0046, 0.019933}},
    {"Espresso", {0.72378, 0.84557, 1.0247}, {4.7984, 6.5751, 8.8493}},
    {"Mint Mocha Coffee", {0.31602, 0.38538, 0.48131}, {3.772, 5.8228, 7.82}},
    {"Lowfat Soy Milk",
     {0.30576, 0.34233, 0.61664},
     {0.0014375, 0.0071875, 0.035937}},
    {"Regular Soy Milk",
     {0.59223, 0.73866, 1.4693},
     {0.0019167, 0.0095833, 0.065167}},
    {"Lowfat Chocolate Milk",
     {0.64925, 0.83916, 1.1057},
     {0.0115, 0.0368, 0.1564}},
    {"Regular Chocolate Milk",
     {1.4585, 2.1289, 2.9527},
     {0.010063, 0.043125, 0.14375}},
    {"Coke", {8.9053e-05, 8.372e-05, 0}, {0.10014, 0.16503, 0.2468}},
    {"Pepsi", {6.1697e-05, 4.2564e-05, 0}, {0.091641, 0.14158, 0.20729}},
    {"Sprite",
     {6.0306e-06, 6.4139e-06, 6.5504e-06},
     {0.001886, 0.0018308, 0.0020025}},
    {"Gatorade",
     {0.0024574, 0.003007, 0.0037325},
     {0.024794, 0.019289, 0.008878}},
    {"Chardonnay",
     {1.7982e-05, 1.3758e-05, 1.2023e-05},
     {0.010782, 0.011855, 0.023997}},
    {"White Zinfandel",
     {1.7501e-05, 1.9069e-05, 1.288e-05},
     {0.012072, 0.016184, 0.019843}},
    {"Merlot", {2.1129e-05, 0, 0}, {0.11632, 0.25191, 0.29434}},
    {"Budweiser Beer",
     {2.4356e-05, 2.4079e-05, 1.0564e-05},
     {0.011492, 0.024911, 0.057786}},
    {"Coors Light Beer",
     {5.0922e-05, 4.301e-05, 0},
     {0.006164, 0.013984, 0.034983}},
    {"Clorox",
     {0.0024035, 0.0031373, 0.003991},
     {0.0033542, 0.014892, 0.026297}},
    {"Apple Juice",
     {0.00013612, 0.00015836, 0.000227},
     {0.012957, 0.023741, 0.052184}},
    {"Cranberry Juice",
     {0.00010402, 0.00011646, 7.8139e-05},
     {0.039437, 0.094223, 0.12426}},
    {"Grape Juice", {5.382e-05, 0, 0}, {0.10404, 0.23958, 0.29325}},
    {"Ruby Grapefruit Juice",
     {0.011002, 0.010927, 0.011036},
     {0.085867, 0.18314, 0.25262}},
    {"White Grapefruit Juice",
     {0.22826, 0.23998, 0.32748},
     {0.0138, 0.018831, 0.056781}},
    {"Shampoo",
     {0.0007176, 0.0008303, 0.0009016},
     {0.014107, 0.045693, 0.061717}},
    {"Strawberry Shampoo",
     {0.00015671, 0.00015947, 1.518e-05},
     {0.01449, 0.05796, 0.075823}},
    {"Head & Shoulders Shampoo",
     {0.023805, 0.028804, 0.034306},
     {0.084621, 0.15688, 0.20365}},
    {"Lemon Tea Powder",
     {0.040224, 0.045264, 0.051081},
     {2.4288, 4.5757, 7.2127}},
    {"Orange Powder",
     {0.00015617, 0.00017482, 0.0001762},
     {0.001449, 0.003441, 0.007863}},
    {"Pink Lemonade Powder",
     {0.00012103, 0.00013073, 0.00012528},
     {0.001165, 0.002366, 0.003195}},
    {"Cappuccino Powder", {1.8436, 2.5851, 2.1662}, {35.844, 49.547, 61.084}},
    {"Salt Powder", {0.027333, 0.032451, 0.031979}, {0.28415, 0.3257, 0.34148}},
    {"Sugar Powder",
     {0.00022272, 0.00025513, 0.000271},
     {0.012638, 0.031051, 0.050124}},
    {"Suisse Mocha Powder", {2.7979, 3.5452, 4.3365}, {17.502, 27.004, 35.433}},
    {"Pacific Ocean Surface Water",
     {0.0001764, 0.00032095, 0.00019617},
     {0.031845, 0.031324, 0.030147}}};

// Mie phase function and inverse of CDF

alglib::spline1dinterpolant CloudMie::CerpPhase = alglib::spline1dinterpolant();
alglib::spline1dinterpolant CloudMie::CerpInv = alglib::spline1dinterpolant();

#pragma region Theta
alglib::real_1d_array CloudMie::Theta =
    "[0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.1, 1.2, 1.3, 1.4, "
    "1.5, 1.6, 1.7, 1.8, 1.9, 2, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, "
    "3, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9, 4, 4.1, 4.2, 4.3, 4.4, "
    "4.5, 4.6, 4.7, 4.8, 4.9, 5, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8, 5.9, "
    "6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8, 6.9, 7, 7.1, 7.2, 7.3, 7.4, "
    "7.5, 7.6, 7.7, 7.8, 7.9, 8, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 8.8, 8.9, "
    "9, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 9.8, 9.9, 10, 10.1, 10.2, 10.3, "
    "10.4, 10.5, 10.6, 10.7, 10.8, 10.9, 11, 11.1, 11.2, 11.3, 11.4, 11.5, "
    "11.6, 11.7, 11.8, 11.9, 12, 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 12.7, "
    "12.8, 12.9, 13, 13.1, 13.2, 13.3, 13.4, 13.5, 13.6, 13.7, 13.8, 13.9, 14, "
    "14.1, 14.2, 14.3, 14.4, 14.5, 14.6, 14.7, 14.8, 14.9, 15, 15.1, 15.2, "
    "15.3, 15.4, 15.5, 15.6, 15.7, 15.8, 15.9, 16, 16.1, 16.2, 16.3, 16.4, "
    "16.5, 16.6, 16.7, 16.8, 16.9, 17, 17.1, 17.2, 17.3, 17.4, 17.5, 17.6, "
    "17.7, 17.8, 17.9, 18, 18.1, 18.2, 18.3, 18.4, 18.5, 18.6, 18.7, 18.8, "
    "18.9, 19, 19.1, 19.2, 19.3, 19.4, 19.5, 19.6, 19.7, 19.8, 19.9, 20, 20.1, "
    "20.2, 20.3, 20.4, 20.5, 20.6, 20.7, 20.8, 20.9, 21, 21.1, 21.2, 21.3, "
    "21.4, 21.5, 21.6, 21.7, 21.8, 21.9, 22, 22.1, 22.2, 22.3, 22.4, 22.5, "
    "22.6, 22.7, 22.8, 22.9, 23, 23.1, 23.2, 23.3, 23.4, 23.5, 23.6, 23.7, "
    "23.8, 23.9, 24, 24.1, 24.2, 24.3, 24.4, 24.5, 24.6, 24.7, 24.8, 24.9, 25, "
    "25.1, 25.2, 25.3, 25.4, 25.5, 25.6, 25.7, 25.8, 25.9, 26, 26.1, 26.2, "
    "26.3, 26.4, 26.5, 26.6, 26.7, 26.8, 26.9, 27, 27.1, 27.2, 27.3, 27.4, "
    "27.5, 27.6, 27.7, 27.8, 27.9, 28, 28.1, 28.2, 28.3, 28.4, 28.5, 28.6, "
    "28.7, 28.8, 28.9, 29, 29.1, 29.2, 29.3, 29.4, 29.5, 29.6, 29.7, 29.8, "
    "29.9, 30, 30.1, 30.2, 30.3, 30.4, 30.5, 30.6, 30.7, 30.8, 30.9, 31, 31.1, "
    "31.2, 31.3, 31.4, 31.5, 31.6, 31.7, 31.8, 31.9, 32, 32.1, 32.2, 32.3, "
    "32.4, 32.5, 32.6, 32.7, 32.8, 32.9, 33, 33.1, 33.2, 33.3, 33.4, 33.5, "
    "33.6, 33.7, 33.8, 33.9, 34, 34.1, 34.2, 34.3, 34.4, 34.5, 34.6, 34.7, "
    "34.8, 34.9, 35, 35.1, 35.2, 35.3, 35.4, 35.5, 35.6, 35.7, 35.8, 35.9, 36, "
    "36.1, 36.2, 36.3, 36.4, 36.5, 36.6, 36.7, 36.8, 36.9, 37, 37.1, 37.2, "
    "37.3, 37.4, 37.5, 37.6, 37.7, 37.8, 37.9, 38, 38.1, 38.2, 38.3, 38.4, "
    "38.5, 38.6, 38.7, 38.8, 38.9, 39, 39.1, 39.2, 39.3, 39.4, 39.5, 39.6, "
    "39.7, 39.8, 39.9, 40, 40.1, 40.2, 40.3, 40.4, 40.5, 40.6, 40.7, 40.8, "
    "40.9, 41, 41.1, 41.2, 41.3, 41.4, 41.5, 41.6, 41.7, 41.8, 41.9, 42, 42.1, "
    "42.2, 42.3, 42.4, 42.5, 42.6, 42.7, 42.8, 42.9, 43, 43.1, 43.2, 43.3, "
    "43.4, 43.5, 43.6, 43.7, 43.8, 43.9, 44, 44.1, 44.2, 44.3, 44.4, 44.5, "
    "44.6, 44.7, 44.8, 44.9, 45, 45.1, 45.2, 45.3, 45.4, 45.5, 45.6, 45.7, "
    "45.8, 45.9, 46, 46.1, 46.2, 46.3, 46.4, 46.5, 46.6, 46.7, 46.8, 46.9, 47, "
    "47.1, 47.2, 47.3, 47.4, 47.5, 47.6, 47.7, 47.8, 47.9, 48, 48.1, 48.2, "
    "48.3, 48.4, 48.5, 48.6, 48.7, 48.8, 48.9, 49, 49.1, 49.2, 49.3, 49.4, "
    "49.5, 49.6, 49.7, 49.8, 49.9, 50, 50.1, 50.2, 50.3, 50.4, 50.5, 50.6, "
    "50.7, 50.8, 50.9, 51, 51.1, 51.2, 51.3, 51.4, 51.5, 51.6, 51.7, 51.8, "
    "51.9, 52, 52.1, 52.2, 52.3, 52.4, 52.5, 52.6, 52.7, 52.8, 52.9, 53, 53.1, "
    "53.2, 53.3, 53.4, 53.5, 53.6, 53.7, 53.8, 53.9, 54, 54.1, 54.2, 54.3, "
    "54.4, 54.5, 54.6, 54.7, 54.8, 54.9, 55, 55.1, 55.2, 55.3, 55.4, 55.5, "
    "55.6, 55.7, 55.8, 55.9, 56, 56.1, 56.2, 56.3, 56.4, 56.5, 56.6, 56.7, "
    "56.8, 56.9, 57, 57.1, 57.2, 57.3, 57.4, 57.5, 57.6, 57.7, 57.8, 57.9, 58, "
    "58.1, 58.2, 58.3, 58.4, 58.5, 58.6, 58.7, 58.8, 58.9, 59, 59.1, 59.2, "
    "59.3, 59.4, 59.5, 59.6, 59.7, 59.8, 59.9, 60, 60.1, 60.2, 60.3, 60.4, "
    "60.5, 60.6, 60.7, 60.8, 60.9, 61, 61.1, 61.2, 61.3, 61.4, 61.5, 61.6, "
    "61.7, 61.8, 61.9, 62, 62.1, 62.2, 62.3, 62.4, 62.5, 62.6, 62.7, 62.8, "
    "62.9, 63, 63.1, 63.2, 63.3, 63.4, 63.5, 63.6, 63.7, 63.8, 63.9, 64, 64.1, "
    "64.2, 64.3, 64.4, 64.5, 64.6, 64.7, 64.8, 64.9, 65, 65.1, 65.2, 65.3, "
    "65.4, 65.5, 65.6, 65.7, 65.8, 65.9, 66, 66.1, 66.2, 66.3, 66.4, 66.5, "
    "66.6, 66.7, 66.8, 66.9, 67, 67.1, 67.2, 67.3, 67.4, 67.5, 67.6, 67.7, "
    "67.8, 67.9, 68, 68.1, 68.2, 68.3, 68.4, 68.5, 68.6, 68.7, 68.8, 68.9, 69, "
    "69.1, 69.2, 69.3, 69.4, 69.5, 69.6, 69.7, 69.8, 69.9, 70, 70.1, 70.2, "
    "70.3, 70.4, 70.5, 70.6, 70.7, 70.8, 70.9, 71, 71.1, 71.2, 71.3, 71.4, "
    "71.5, 71.6, 71.7, 71.8, 71.9, 72, 72.1, 72.2, 72.3, 72.4, 72.5, 72.6, "
    "72.7, 72.8, 72.9, 73, 73.1, 73.2, 73.3, 73.4, 73.5, 73.6, 73.7, 73.8, "
    "73.9, 74, 74.1, 74.2, 74.3, 74.4, 74.5, 74.6, 74.7, 74.8, 74.9, 75, 75.1, "
    "75.2, 75.3, 75.4, 75.5, 75.6, 75.7, 75.8, 75.9, 76, 76.1, 76.2, 76.3, "
    "76.4, 76.5, 76.6, 76.7, 76.8, 76.9, 77, 77.1, 77.2, 77.3, 77.4, 77.5, "
    "77.6, 77.7, 77.8, 77.9, 78, 78.1, 78.2, 78.3, 78.4, 78.5, 78.6, 78.7, "
    "78.8, 78.9, 79, 79.1, 79.2, 79.3, 79.4, 79.5, 79.6, 79.7, 79.8, 79.9, 80, "
    "80.1, 80.2, 80.3, 80.4, 80.5, 80.6, 80.7, 80.8, 80.9, 81, 81.1, 81.2, "
    "81.3, 81.4, 81.5, 81.6, 81.7, 81.8, 81.9, 82, 82.1, 82.2, 82.3, 82.4, "
    "82.5, 82.6, 82.7, 82.8, 82.9, 83, 83.1, 83.2, 83.3, 83.4, 83.5, 83.6, "
    "83.7, 83.8, 83.9, 84, 84.1, 84.2, 84.3, 84.4, 84.5, 84.6, 84.7, 84.8, "
    "84.9, 85, 85.1, 85.2, 85.3, 85.4, 85.5, 85.6, 85.7, 85.8, 85.9, 86, 86.1, "
    "86.2, 86.3, 86.4, 86.5, 86.6, 86.7, 86.8, 86.9, 87, 87.1, 87.2, 87.3, "
    "87.4, 87.5, 87.6, 87.7, 87.8, 87.9, 88, 88.1, 88.2, 88.3, 88.4, 88.5, "
    "88.6, 88.7, 88.8, 88.9, 89, 89.1, 89.2, 89.3, 89.4, 89.5, 89.6, 89.7, "
    "89.8, 89.9, 90, 90.1, 90.2, 90.3, 90.4, 90.5, 90.6, 90.7, 90.8, 90.9, 91, "
    "91.1, 91.2, 91.3, 91.4, 91.5, 91.6, 91.7, 91.8, 91.9, 92, 92.1, 92.2, "
    "92.3, 92.4, 92.5, 92.6, 92.7, 92.8, 92.9, 93, 93.1, 93.2, 93.3, 93.4, "
    "93.5, 93.6, 93.7, 93.8, 93.9, 94, 94.1, 94.2, 94.3, 94.4, 94.5, 94.6, "
    "94.7, 94.8, 94.9, 95, 95.1, 95.2, 95.3, 95.4, 95.5, 95.6, 95.7, 95.8, "
    "95.9, 96, 96.1, 96.2, 96.3, 96.4, 96.5, 96.6, 96.7, 96.8, 96.9, 97, 97.1, "
    "97.2, 97.3, 97.4, 97.5, 97.6, 97.7, 97.8, 97.9, 98, 98.1, 98.2, 98.3, "
    "98.4, 98.5, 98.6, 98.7, 98.8, 98.9, 99, 99.1, 99.2, 99.3, 99.4, 99.5, "
    "99.6, 99.7, 99.8, 99.9, 100, 100.1, 100.2, 100.3, 100.4, 100.5, 100.6, "
    "100.7, 100.8, 100.9, 101, 101.1, 101.2, 101.3, 101.4, 101.5, 101.6, "
    "101.7, 101.8, 101.9, 102, 102.1, 102.2, 102.3, 102.4, 102.5, 102.6, "
    "102.7, 102.8, 102.9, 103, 103.1, 103.2, 103.3, 103.4, 103.5, 103.6, "
    "103.7, 103.8, 103.9, 104, 104.1, 104.2, 104.3, 104.4, 104.5, 104.6, "
    "104.7, 104.8, 104.9, 105, 105.1, 105.2, 105.3, 105.4, 105.5, 105.6, "
    "105.7, 105.8, 105.9, 106, 106.1, 106.2, 106.3, 106.4, 106.5, 106.6, "
    "106.7, 106.8, 106.9, 107, 107.1, 107.2, 107.3, 107.4, 107.5, 107.6, "
    "107.7, 107.8, 107.9, 108, 108.1, 108.2, 108.3, 108.4, 108.5, 108.6, "
    "108.7, 108.8, 108.9, 109, 109.1, 109.2, 109.3, 109.4, 109.5, 109.6, "
    "109.7, 109.8, 109.9, 110, 110.1, 110.2, 110.3, 110.4, 110.5, 110.6, "
    "110.7, 110.8, 110.9, 111, 111.1, 111.2, 111.3, 111.4, 111.5, 111.6, "
    "111.7, 111.8, 111.9, 112, 112.1, 112.2, 112.3, 112.4, 112.5, 112.6, "
    "112.7, 112.8, 112.9, 113, 113.1, 113.2, 113.3, 113.4, 113.5, 113.6, "
    "113.7, 113.8, 113.9, 114, 114.1, 114.2, 114.3, 114.4, 114.5, 114.6, "
    "114.7, 114.8, 114.9, 115, 115.1, 115.2, 115.3, 115.4, 115.5, 115.6, "
    "115.7, 115.8, 115.9, 116, 116.1, 116.2, 116.3, 116.4, 116.5, 116.6, "
    "116.7, 116.8, 116.9, 117, 117.1, 117.2, 117.3, 117.4, 117.5, 117.6, "
    "117.7, 117.8, 117.9, 118, 118.1, 118.2, 118.3, 118.4, 118.5, 118.6, "
    "118.7, 118.8, 118.9, 119, 119.1, 119.2, 119.3, 119.4, 119.5, 119.6, "
    "119.7, 119.8, 119.9, 120, 120.1, 120.2, 120.3, 120.4, 120.5, 120.6, "
    "120.7, 120.8, 120.9, 121, 121.1, 121.2, 121.3, 121.4, 121.5, 121.6, "
    "121.7, 121.8, 121.9, 122, 122.1, 122.2, 122.3, 122.4, 122.5, 122.6, "
    "122.7, 122.8, 122.9, 123, 123.1, 123.2, 123.3, 123.4, 123.5, 123.6, "
    "123.7, 123.8, 123.9, 124, 124.1, 124.2, 124.3, 124.4, 124.5, 124.6, "
    "124.7, 124.8, 124.9, 125, 125.1, 125.2, 125.3, 125.4, 125.5, 125.6, "
    "125.7, 125.8, 125.9, 126, 126.1, 126.2, 126.3, 126.4, 126.5, 126.6, "
    "126.7, 126.8, 126.9, 127, 127.1, 127.2, 127.3, 127.4, 127.5, 127.6, "
    "127.7, 127.8, 127.9, 128, 128.1, 128.2, 128.3, 128.4, 128.5, 128.6, "
    "128.7, 128.8, 128.9, 129, 129.1, 129.2, 129.3, 129.4, 129.5, 129.6, "
    "129.7, 129.8, 129.9, 130, 130.1, 130.2, 130.3, 130.4, 130.5, 130.6, "
    "130.7, 130.8, 130.9, 131, 131.1, 131.2, 131.3, 131.4, 131.5, 131.6, "
    "131.7, 131.8, 131.9, 132, 132.1, 132.2, 132.3, 132.4, 132.5, 132.6, "
    "132.7, 132.8, 132.9, 133, 133.1, 133.2, 133.3, 133.4, 133.5, 133.6, "
    "133.7, 133.8, 133.9, 134, 134.1, 134.2, 134.3, 134.4, 134.5, 134.6, "
    "134.7, 134.8, 134.9, 135, 135.1, 135.2, 135.3, 135.4, 135.5, 135.6, "
    "135.7, 135.8, 135.9, 136, 136.1, 136.2, 136.3, 136.4, 136.5, 136.6, "
    "136.7, 136.8, 136.9, 137, 137.1, 137.2, 137.3, 137.4, 137.5, 137.6, "
    "137.7, 137.8, 137.9, 138, 138.1, 138.2, 138.3, 138.4, 138.5, 138.6, "
    "138.7, 138.8, 138.9, 139, 139.1, 139.2, 139.3, 139.4, 139.5, 139.6, "
    "139.7, 139.8, 139.9, 140, 140.1, 140.2, 140.3, 140.4, 140.5, 140.6, "
    "140.7, 140.8, 140.9, 141, 141.1, 141.2, 141.3, 141.4, 141.5, 141.6, "
    "141.7, 141.8, 141.9, 142, 142.1, 142.2, 142.3, 142.4, 142.5, 142.6, "
    "142.7, 142.8, 142.9, 143, 143.1, 143.2, 143.3, 143.4, 143.5, 143.6, "
    "143.7, 143.8, 143.9, 144, 144.1, 144.2, 144.3, 144.4, 144.5, 144.6, "
    "144.7, 144.8, 144.9, 145, 145.1, 145.2, 145.3, 145.4, 145.5, 145.6, "
    "145.7, 145.8, 145.9, 146, 146.1, 146.2, 146.3, 146.4, 146.5, 146.6, "
    "146.7, 146.8, 146.9, 147, 147.1, 147.2, 147.3, 147.4, 147.5, 147.6, "
    "147.7, 147.8, 147.9, 148, 148.1, 148.2, 148.3, 148.4, 148.5, 148.6, "
    "148.7, 148.8, 148.9, 149, 149.1, 149.2, 149.3, 149.4, 149.5, 149.6, "
    "149.7, 149.8, 149.9, 150, 150.1, 150.2, 150.3, 150.4, 150.5, 150.6, "
    "150.7, 150.8, 150.9, 151, 151.1, 151.2, 151.3, 151.4, 151.5, 151.6, "
    "151.7, 151.8, 151.9, 152, 152.1, 152.2, 152.3, 152.4, 152.5, 152.6, "
    "152.7, 152.8, 152.9, 153, 153.1, 153.2, 153.3, 153.4, 153.5, 153.6, "
    "153.7, 153.8, 153.9, 154, 154.1, 154.2, 154.3, 154.4, 154.5, 154.6, "
    "154.7, 154.8, 154.9, 155, 155.1, 155.2, 155.3, 155.4, 155.5, 155.6, "
    "155.7, 155.8, 155.9, 156, 156.1, 156.2, 156.3, 156.4, 156.5, 156.6, "
    "156.7, 156.8, 156.9, 157, 157.1, 157.2, 157.3, 157.4, 157.5, 157.6, "
    "157.7, 157.8, 157.9, 158, 158.1, 158.2, 158.3, 158.4, 158.5, 158.6, "
    "158.7, 158.8, 158.9, 159, 159.1, 159.2, 159.3, 159.4, 159.5, 159.6, "
    "159.7, 159.8, 159.9, 160, 160.1, 160.2, 160.3, 160.4, 160.5, 160.6, "
    "160.7, 160.8, 160.9, 161, 161.1, 161.2, 161.3, 161.4, 161.5, 161.6, "
    "161.7, 161.8, 161.9, 162, 162.1, 162.2, 162.3, 162.4, 162.5, 162.6, "
    "162.7, 162.8, 162.9, 163, 163.1, 163.2, 163.3, 163.4, 163.5, 163.6, "
    "163.7, 163.8, 163.9, 164, 164.1, 164.2, 164.3, 164.4, 164.5, 164.6, "
    "164.7, 164.8, 164.9, 165, 165.1, 165.2, 165.3, 165.4, 165.5, 165.6, "
    "165.7, 165.8, 165.9, 166, 166.1, 166.2, 166.3, 166.4, 166.5, 166.6, "
    "166.7, 166.8, 166.9, 167, 167.1, 167.2, 167.3, 167.4, 167.5, 167.6, "
    "167.7, 167.8, 167.9, 168, 168.1, 168.2, 168.3, 168.4, 168.5, 168.6, "
    "168.7, 168.8, 168.9, 169, 169.1, 169.2, 169.3, 169.4, 169.5, 169.6, "
    "169.7, 169.8, 169.9, 170, 170.1, 170.2, 170.3, 170.4, 170.5, 170.6, "
    "170.7, 170.8, 170.9, 171, 171.1, 171.2, 171.3, 171.4, 171.5, 171.6, "
    "171.7, 171.8, 171.9, 172, 172.1, 172.2, 172.3, 172.4, 172.5, 172.6, "
    "172.7, 172.8, 172.9, 173, 173.1, 173.2, 173.3, 173.4, 173.5, 173.6, "
    "173.7, 173.8, 173.9, 174, 174.1, 174.2, 174.3, 174.4, 174.5, 174.6, "
    "174.7, 174.8, 174.9, 175, 175.1, 175.2, 175.3, 175.4, 175.5, 175.6, "
    "175.7, 175.8, 175.9, 176, 176.1, 176.2, 176.3, 176.4, 176.5, 176.6, "
    "176.7, 176.8, 176.9, 177, 177.1, 177.2, 177.3, 177.4, 177.5, 177.6, "
    "177.7, 177.8, 177.9, 178, 178.1, 178.2, 178.3, 178.4, 178.5, 178.6, "
    "178.7, 178.8, 178.9, 179, 179.1, 179.2, 179.3, 179.4, 179.5, 179.6, "
    "179.7, 179.8, 179.9, 180]";
#pragma endregion

#pragma region MiePhase 
alglib::real_1d_array CloudMie::MiePhase =
    "[124.9880423, 123.5402683, 119.2845982, 112.4762922, 103.5159665, "
    "92.91517695, 81.25350089, 69.1315964,  57.12499995, 45.7431435, "
    "35.39728682, 26.37988467, 18.85650599, 12.86997659, 8.355110479, "
    "5.161381097, 3.080267449, 1.87383847,  1.30139643,  1.141615398, "
    "1.208471002, 1.360226803, 1.501682473, 1.580679067, 1.580409287, "
    "1.509350694, 1.390626752, 1.252344316, 1.120026546, 1.011743613, "
    "0.936028122, 0.892224052, 0.872611335, 0.865499462, 0.858490668, "
    "0.841249869, 0.807341273, 0.754949229, 0.686544113, 0.607743287, "
    "0.525727892, 0.447601367, 0.379023997, 0.323350981, 0.281367655, "
    "0.2515838,   0.230944107, 0.215749941, 0.202574492, 0.188984977, "
    "0.17394957,  0.15788634,  0.142389083, 0.129725478, 0.122236757, "
    "0.121771884, 0.129266051, 0.144531276, 0.166276742, 0.192329409, "
    "0.219990343, 0.246444743, 0.269144953, 0.286103063, 0.296057263, "
    "0.298506714, 0.29363645,  0.282171486, 0.26520527,  0.244042315, "
    "0.220080965, 0.194744382, 0.169450902, 0.145603009, 0.124570092, "
    "0.107644177, 0.095958581, 0.090373603, 0.091347265, 0.098818836, "
    "0.112135982, 0.130051783, 0.150806375, 0.172292049, 0.192283734, "
    "0.208702523, 0.21987151,  0.22472245,  0.222919049, 0.214876544, "
    "0.201674997, 0.184881949, 0.166315155, 0.147785408, 0.130861187, "
    "0.116691056, 0.105907744, 0.098622175, 0.094499453, 0.092895157, "
    "0.093021497, 0.094110471, 0.095544979, 0.096937908, 0.098151219, "
    "0.099259576, 0.100473497, 0.102043571, 0.104168842, 0.106929199, "
    "0.110254528, 0.113934237, 0.117661565, 0.121099874, 0.12395412, "
    "0.126030649, 0.127272095, 0.127760429, 0.127688703, 0.127308988, "
    "0.126869056, 0.126552434, 0.126435283, 0.126469506, 0.12649557, "
    "0.12628198,  0.125582644, 0.124199666, 0.122038035, 0.119140492, "
    "0.115695006, 0.112012865, 0.10848133,  0.105499696, 0.103410815, "
    "0.102440768, 0.102657692, 0.103956976, 0.106075077, 0.108628993, "
    "0.111174017, 0.113269503, 0.114541503, 0.114732299, 0.11372969, "
    "0.111572794, 0.108435324, 0.104590898, 0.100367543, 0.09609956, "
    "0.092084493, 0.0885512,   0.085642438, 0.083412569, 0.081838416, "
    "0.08083943,  0.080302413, 0.080106079, 0.080141575, 0.080326479, "
    "0.080611307, 0.080978987, 0.08143877,  0.082016569, 0.082743809, "
    "0.083646526, 0.084735984, 0.086001582, 0.08740642,  0.088885673, "
    "0.0903479,   0.091679408, 0.092751799, 0.093432676, 0.093599156, "
    "0.093153314, 0.092038092, 0.090251642, 0.087857752, 0.084989985, "
    "0.081847696, 0.078682931, 0.075778544, 0.073419228, 0.071858553, "
    "0.071286059, 0.071798959, 0.07338274,  0.075904086, 0.079117995, "
    "0.082689113, 0.086225304, 0.089319697, 0.091596183, 0.092752711, "
    "0.092596933, 0.091069678, 0.088253287, 0.084363778, 0.07972784, "
    "0.074747509, 0.069856809, 0.065475489, 0.061965168, 0.059592713, "
    "0.058504676, 0.058715219, 0.060108357, 0.062453762, 0.065433979, "
    "0.068679789, 0.071809752, 0.074469718, 0.076368217, 0.077304224, "
    "0.077184643, 0.076029979, 0.073967862, 0.071215406, 0.068052474, "
    "0.064788939, 0.061729624, 0.059140886, 0.057222607, 0.056088746, "
    "0.055758578, 0.056159488, 0.057140736, 0.058496242, 0.059993314, "
    "0.061403455, 0.062531172, 0.063237005, 0.063451846, 0.063180857, "
    "0.062496808, 0.061524144, 0.060416434, 0.059330726, 0.058402745, "
    "0.057726628, 0.057342128, 0.057231011, 0.057322922, 0.057509529, "
    "0.057664494, 0.057665984, 0.057418089, 0.056867774, 0.056014734, "
    "0.054912685, 0.053661974, 0.052394733, 0.051254913, 0.050376301, "
    "0.049861855, 0.049767452, 0.050092422, 0.05077822,  0.05171533, "
    "0.052757356, 0.053740208, 0.05450364,  0.054912135, 0.054872316, "
    "0.054344613, 0.053347793, 0.051955954, 0.050288632, 0.048495515, "
    "0.046737945, 0.04516967,  0.043919284, 0.04307646,  0.042683457, "
    "0.042732629, 0.043169877, 0.043903214, 0.04481508,  0.045776638, "
    "0.046662242, 0.047362344, 0.04779352,  0.04790474,  0.047679575, "
    "0.04713457,  0.046314419, 0.045284929, 0.044124833, 0.042917507, "
    "0.041743478, 0.040674318, 0.039768235, 0.039067382, 0.038596688, "
    "0.038363867, 0.03836027,  0.038562276, 0.038933047, 0.039424628, "
    "0.039980463, 0.040538471, 0.041034783, 0.041408163, 0.041604937, "
    "0.041584075, 0.041321895, 0.040815725, 0.040085883, 0.039175407, "
    "0.038147231, 0.037078805, 0.036054558, 0.035156944, 0.034457101, "
    "0.034006324, 0.033829512, 0.033921578, 0.034247439, 0.034745742, "
    "0.035335954, 0.035927969, 0.036433,    0.036774315, 0.036896376, "
    "0.036771171, 0.036400871, 0.035816533, 0.035073062, 0.034241229, "
    "0.033397915, 0.032615991, 0.031955247, 0.031455609, 0.031133486, "
    "0.030981599, 0.030972131, 0.031062541, 0.031202999, 0.03134424, "
    "0.031444608, 0.031475259, 0.031422839, 0.031289398, 0.03108975, "
    "0.030846907, 0.030586498, 0.030331204, 0.030096218, 0.029886494, "
    "0.029696223, 0.029510583, 0.029309382, 0.029071897, 0.028781994, "
    "0.028432567, 0.028028435, 0.027587114, 0.027137212, 0.026714636, "
    "0.026357161, 0.026098202, 0.02596082,  0.025952955, 0.026064748, "
    "0.026268482, 0.026521284, 0.026770296, 0.026959631, 0.027038123, "
    "0.026966741, 0.026724562, 0.026312362, 0.025753262, 0.025090246, "
    "0.024380873, 0.023689866, 0.023080636, 0.022606894, 0.022305554, "
    "0.022191901, 0.022257689, 0.022472415, 0.022787548, 0.023143093, "
    "0.023475545, 0.023726115, 0.023848092, 0.023812384, 0.023610537, "
    "0.023254929, 0.022776228, 0.022218597, 0.0216334,   0.021072337, "
    "0.020580974, 0.0201935,   0.019929333, 0.019791891, 0.019769523, "
    "0.019838288, 0.019966053, 0.020117225, 0.020257428, 0.020357504, "
    "0.020396369, 0.020362487, 0.020253936, 0.020077244, 0.019845334, "
    "0.019574999, 0.019284318, 0.018990404, 0.018707722, 0.018447115, "
    "0.018215532, 0.018016322, 0.017849919, 0.017714677, 0.017607674, "
    "0.017525315, 0.017463668, 0.017418547, 0.017385406, 0.017359156, "
    "0.017334054, 0.017303742, 0.017261533, 0.017200921, 0.01711627, "
    "0.017003584, 0.016861197, 0.016690271, 0.016494964, 0.016282222, "
    "0.016061175, 0.015842203, 0.01563579,  0.015451323, 0.015295995, "
    "0.015173979, 0.015085968, 0.015029167, 0.014997696, 0.014983366, "
    "0.014976689, 0.014967981, 0.014948407, 0.014910839, 0.014850424, "
    "0.014764841, 0.014654232, 0.014520889, 0.014368773, 0.014202967, "
    "0.014029149, 0.01385316,  0.013680676, 0.013517003, 0.013366918, "
    "0.013234548, 0.013123188, 0.013035071, 0.012971052, 0.012930282, "
    "0.012909916, 0.012904966, 0.012908391, 0.012911482, 0.012904577, "
    "0.012878061, 0.012823549, 0.012735107, 0.012610305, 0.012450922, "
    "0.012263144, 0.012057152, 0.011846112, 0.011644639, 0.011466945, "
    "0.011324912, 0.011226376, 0.011173901, 0.011164248, 0.011188644, "
    "0.011233856, 0.011283923, 0.011322308, 0.011334154, 0.011308315, "
    "0.011238854, 0.011125778, 0.010974919, 0.010796977, 0.010605882, "
    "0.010416752, 0.010243739, 0.01009812,  0.009986887, 0.009912046, "
    "0.009870679, 0.009855735, 0.009857365, 0.009864569, 0.009866875, "
    "0.009855779, 0.009825741, 0.009774618, 0.009703517, 0.009616151, "
    "0.009517853, 0.009414469, 0.009311313, 0.009212382, 0.009119936, "
    "0.009034466, 0.008955032, 0.008879834, 0.008806893, 0.00873468, "
    "0.008662551, 0.008590931, 0.008521194, 0.008455299, 0.00839526, "
    "0.008342578, 0.008297752, 0.00825998,  0.008227109, 0.008195865, "
    "0.008162301, 0.008122405, 0.00807275,  0.008011068, 0.007936661, "
    "0.007850562, 0.007755446, 0.007655281, 0.007554805, 0.00745889, "
    "0.00737191,  0.007297187, 0.007236602, 0.007190405, 0.007157241, "
    "0.007134369, 0.007118033, 0.007103924, 0.007087673, 0.007065312, "
    "0.007033664, 0.006990627, 0.006935328, 0.006868164, 0.006790719, "
    "0.006705587, 0.006616104, 0.006526038, 0.006439225, 0.006359211, "
    "0.006288903, 0.006230278, 0.006184163, 0.006150126, 0.006126489, "
    "0.006110482, 0.006098514, 0.00608656,  0.006070603, 0.006047097, "
    "0.006013389, 0.005968033, 0.005910972, 0.005843545, 0.005768315, "
    "0.005688753, 0.005608797, 0.005532363, 0.00546287,  0.005402834, "
    "0.005353597, 0.005315208, 0.005286488, 0.005265234, 0.005248551, "
    "0.005233248, 0.005216241, 0.005194913, 0.005167382, 0.005132653, "
    "0.005090646, 0.005042106, 0.004988429, 0.004931427, 0.004873081, "
    "0.00481531,  0.004759781, 0.004707782, 0.00466015,  0.004617268, "
    "0.004579092, 0.004545217, 0.004514959, 0.004487433, 0.004461635, "
    "0.004436515, 0.004411047, 0.004384293, 0.004355467, 0.004323994, "
    "0.004289555, 0.004252128, 0.004211989, 0.0041697,   0.004126054, "
    "0.004081998, 0.004038527, 0.003996574, 0.003956902, 0.003920022, "
    "0.003886136, 0.003855135, 0.003826629, 0.003800016, 0.003774581, "
    "0.003749598, 0.003724422, 0.003698563, 0.003671721, 0.003643784, "
    "0.0036148,   0.003584919, 0.003554329, 0.003523204, 0.003491664, "
    "0.003459768, 0.00342753,  0.003394962, 0.003362125, 0.003329176, "
    "0.003296396, 0.003264192, 0.003233067, 0.003203545, 0.003176093, "
    "0.00315102,  0.003128397, 0.003107997, 0.003089289, 0.003071472, "
    "0.003053563, 0.00303452,  0.003013389, 0.002989443, 0.002962306, "
    "0.002932022, 0.002899076, 0.002864343, 0.002828986, 0.002794306, "
    "0.002761572, 0.002731848, 0.002705852, 0.002683857, 0.002665651, "
    "0.002650572, 0.002637594, 0.002625464, 0.002612872, 0.00259862, "
    "0.002581775, 0.002561785, 0.002538536, 0.002512359, 0.002483966, "
    "0.002454344, 0.002424617, 0.002395888, 0.002369095, 0.002344893, "
    "0.002323582, 0.00230508,  0.002288961, 0.00227453,  0.002260938, "
    "0.002247317, 0.002232903, 0.002217149, 0.002199787, 0.002180854, "
    "0.00216066,  0.002139719, 0.002118645, 0.002098033, 0.002078353, "
    "0.002059867, 0.002042582, 0.002026261, 0.002010474, 0.001994688, "
    "0.001978379, 0.00196115,  0.001942816, 0.001923463, 0.001903447, "
    "0.001883342, 0.001863845, 0.001845646, 0.001829296, 0.001815088, "
    "0.001802982, 0.001792588, 0.001783207, 0.001773934, 0.001763802, "
    "0.00175195,  0.001737767, 0.001721013, 0.001701874, 0.001680941, "
    "0.001659131, 0.001637539, 0.001617262, 0.001599224, 0.001584021, "
    "0.001571826, 0.001562363, 0.001554957, 0.001548651, 0.001542367, "
    "0.001535083, 0.001526003, 0.001514672, 0.001501037, 0.001485438, "
    "0.001468524, 0.001451125, 0.0014341,   0.001418184, 0.001403872, "
    "0.00139135,  0.001380485, 0.001370887, 0.001361996, 0.001353216, "
    "0.00134403,  0.0013341,   0.001323322, 0.001311827, 0.001299937, "
    "0.001288077, 0.00127667,  0.001266041, 0.001256335, 0.001247487, "
    "0.001239226, 0.001231138, 0.001222744, 0.001213609, 0.001203432, "
    "0.001192114, 0.001179788, 0.001166801, 0.001153653, 0.001140912, "
    "0.001129109, 0.001118643, 0.001109708, 0.001102264, 0.001096043, "
    "0.001090599, 0.001085387, 0.001079855, 0.001073536, 0.001066119, "
    "0.001057487, 0.001047721, 0.001037072, 0.001025902, 0.001014616, "
    "0.001003589, 0.000993108, 0.000983342, 0.00097433,  0.000966, "
    "0.000958202, 0.000950758, 0.000943504, 0.000936321, 0.000929159, "
    "0.000922028, 0.000914983, 0.000908093, 0.000901408, 0.000894934, "
    "0.000888613, 0.000882326, 0.00087591,  0.000869186, 0.000861997, "
    "0.000854243, 0.000845911, 0.000837089, 0.000827965, 0.000818801, "
    "0.000809907, 0.000801589, 0.000794111, 0.000787648, 0.000782264, "
    "0.000777894, 0.000774354, 0.000771359, 0.000768564, 0.000765605, "
    "0.000762146, 0.000757926, 0.000752786, 0.000746692, 0.000739741, "
    "0.000732144, 0.000724201, 0.000716262, 0.000708686, 0.00070179, "
    "0.000695813, 0.000690887, 0.000687014, 0.000684077, 0.000681846, "
    "0.000680016, 0.000678245, 0.000676202, 0.00067361,  0.000670287, "
    "0.000666161, 0.000661285, 0.000655822, 0.000650015, 0.000644151, "
    "0.00063851,  0.000633326, 0.000628747, 0.000624812, 0.000621451, "
    "0.000618497, 0.00061572,  0.000612863, 0.000609694, 0.000606045, "
    "0.000601845, 0.000597129, 0.000592039, 0.000586796, 0.000581665, "
    "0.000576902, 0.000572716, 0.00056922,  0.000566412, 0.000564168, "
    "0.000562255, 0.000560371, 0.000558186, 0.000555401, 0.000551797, "
    "0.000547274, 0.000541878, 0.000535796, 0.000529335, 0.000522879, "
    "0.000516835, 0.000511568, 0.000507349, 0.000504307, 0.000502412, "
    "0.000501473, 0.000501164, 0.000501076, 0.000500774, 0.000499863, "
    "0.000498047, 0.000495173, 0.00049125,  0.000486449, 0.00048107, "
    "0.000475494, 0.000470125, 0.000465324, 0.00046136,  0.000458368, "
    "0.000456341, 0.000455138, 0.000454512, 0.000454165, 0.000453797, "
    "0.000453153, 0.000452067, 0.000450478, 0.000448428, 0.00044604, "
    "0.000443488, 0.000440948, 0.000438563, 0.000436416, 0.000434509, "
    "0.000432779, 0.000431108, 0.000429364, 0.000427432, 0.000425249, "
    "0.000422821, 0.000420231, 0.000417621, 0.00041517,  0.000413051, "
    "0.000411399, 0.000410276, 0.000409656, 0.000409422, 0.000409387, "
    "0.000409322, 0.000408999, 0.000408229, 0.000406895, 0.000404973, "
    "0.000402533, 0.000399721, 0.000396737, 0.000393796, 0.000391092, "
    "0.000388767, 0.000386897, 0.000385487, 0.000384478, 0.000383768, "
    "0.000383241, 0.000382785, 0.000382313, 0.000381774, 0.000381153, "
    "0.00038046,  0.000379717, 0.000378946, 0.000378159, 0.000377347, "
    "0.000376491, 0.000375563, 0.000374543, 0.000373424, 0.000372226, "
    "0.000370993, 0.000369786, 0.000368676, 0.000367724, 0.00036697, "
    "0.000366424, 0.000366063, 0.000365838, 0.000365685, 0.000365545, "
    "0.000365374, 0.00036516,  0.000364922, 0.000364705, 0.000364566, "
    "0.000364548, 0.000364669, 0.0003649,   0.000365163, 0.00036534, "
    "0.00036529,  0.000364876, 0.000364003, 0.000362638, 0.000360833, "
    "0.000358725, 0.000356519, 0.000354458, 0.000352782, 0.000351684, "
    "0.000351267, 0.000351528, 0.000352342, 0.000353487, 0.000354676, "
    "0.000355601, 0.000355993, 0.000355661, 0.000354528, 0.000352641, "
    "0.000350163, 0.00034734,  0.000344457, 0.000341792, 0.000339567, "
    "0.000337914, 0.000336863, 0.000336344, 0.000336212, 0.000336276, "
    "0.000336343, 0.000336251, 0.000335897, 0.000335245, 0.00033433, "
    "0.000333233, 0.000332066, 0.000330938, 0.000329938, 0.000329119, "
    "0.000328492, 0.000328035, 0.000327704, 0.000327452, 0.000327238, "
    "0.000327042, 0.000326864, 0.00032672,  0.000326635, 0.000326627, "
    "0.000326703, 0.000326855, 0.000327063, 0.000327304, 0.000327569, "
    "0.000327871, 0.000328257, 0.000328805, 0.000329613, 0.000330782, "
    "0.000332389, 0.000334461, 0.000336957, 0.000339761, 0.000342687, "
    "0.000345506, 0.000347979, 0.000349907, 0.000351166, 0.000351747, "
    "0.000351766, 0.000351459, 0.000351149, 0.000351199, 0.000351947, "
    "0.000353648, 0.000356422, 0.000360223, 0.000364841, 0.000369926, "
    "0.000375044, 0.000379746, 0.000383643, 0.000386473, 0.000388148, "
    "0.000388766, 0.000388597, 0.000388037, 0.000387536, 0.000387519, "
    "0.000388315, 0.000390094, 0.000392843, 0.000396367, 0.000400329, "
    "0.000404311, 0.000407889, 0.00041071,  0.000412555, 0.00041337, "
    "0.00041328,  0.000412551, 0.000411545, 0.000410643, 0.000410177, "
    "0.000410366, 0.000411274, 0.000412803, 0.000414711, 0.000416658, "
    "0.000418276, 0.00041923,  0.000419289, 0.000418361, 0.000416515, "
    "0.000413965, 0.000411032, 0.000408083, 0.00040547,  0.000403465, "
    "0.000402215, 0.000401719, 0.000401831, 0.000402288, 0.000402758, "
    "0.000402898, 0.000402414, 0.000401104, 0.000398896, 0.000395851, "
    "0.000392153, 0.000388074, 0.000383933, 0.000380044, 0.000376668, "
    "0.000373983, 0.000372058, 0.000370847, 0.000370211, 0.000369932, "
    "0.000369758, 0.000369434, 0.000368741, 0.000367531, 0.000365737, "
    "0.000363392, 0.000360617, 0.000357611, 0.000354619, 0.000351907, "
    "0.00034972,  0.000348251, 0.000347614, 0.000347826, 0.000348801, "
    "0.000350362, 0.000352265, 0.000354238, 0.000356017, 0.000357397, "
    "0.000358263, 0.000358615, 0.00035857,  0.000358348, 0.000358241, "
    "0.00035856,  0.000359584, 0.000361516, 0.000364443, 0.000368323, "
    "0.000372993, 0.000378199, 0.000383647, 0.000389054, 0.000394204, "
    "0.000398981, 0.000403393, 0.000407558, 0.000411673, 0.00041597, "
    "0.000420661, 0.000425891, 0.000431705, 0.000438049, 0.000444781, "
    "0.000451717, 0.000458678, 0.000465547, 0.0004723,   0.000479022, "
    "0.00048589,  0.000493131, 0.00050096,  0.000509512, 0.00051879, "
    "0.000528636, 0.000538738, 0.000548674, 0.000557992, 0.000566303, "
    "0.000573373, 0.000579194, 0.00058401,  0.0005883,   0.000592702, "
    "0.000597901, 0.000604498, 0.000612885, 0.000623147, 0.000635026, "
    "0.000647938, 0.00066107,  0.00067351,  0.000684415, 0.000693168, "
    "0.0006995,   0.000703547, 0.000705842, 0.000707219, 0.00070867, "
    "0.000711165, 0.000715473, 0.000722025, 0.000730835, 0.000741502, "
    "0.000753287, 0.000765256, 0.000776456, 0.000786089, 0.000793653, "
    "0.000799029, 0.000802482, 0.000804596, 0.000806147, 0.000807945, "
    "0.000810676, 0.00081478,  0.000820376, 0.000827266, 0.000834995, "
    "0.000842965, 0.000850569, 0.000857319, 0.00086294,  0.000867411, "
    "0.000870942, 0.000873907, 0.00087673,  0.000879773, 0.000883237, "
    "0.000887101, 0.000891128, 0.000894913, 0.000897985, 0.000899926, "
    "0.000900486, 0.000899663, 0.000897736, 0.00089523,  0.000892826, "
    "0.00089123,  0.000891024, 0.000892539, 0.000895762, 0.000900313, "
    "0.000905487, 0.000910369, 0.000913983, 0.000915469, 0.000914237, "
    "0.000910081, 0.000903227, 0.000894303, 0.000884245, 0.000874142, "
    "0.000865065, 0.000857893, 0.000853182, 0.000851087, 0.000851349, "
    "0.000853365, 0.000856292, 0.0008592,   0.00086122,  0.000861679, "
    "0.000860188, 0.000856676, 0.000851372, 0.000844734, 0.000837349, "
    "0.000829825, 0.000822681, 0.00081628,  0.000810785, 0.000806168, "
    "0.000802243, 0.000798739, 0.000795364, 0.000791881, 0.000788155, "
    "0.000784172, 0.000780035, 0.000775924, 0.000772046, 0.000768575, "
    "0.000765597, 0.00076308,  0.000760857, 0.000758651, 0.000756111, "
    "0.000752877, 0.000748642, 0.000743218, 0.000736581, 0.000728888, "
    "0.000720474, 0.000711809, 0.00070344,  0.000695916, 0.000689703, "
    "0.00068512,  0.000682285, 0.000681097, 0.000681242, 0.000682237, "
    "0.000683495, 0.000684407, 0.000684427, 0.000683145, 0.00068035, "
    "0.000676051, 0.000670485, 0.000664079, 0.000657399, 0.000651079, "
    "0.000645744, 0.000641942, 0.000640089, 0.000640422, 0.000642996, "
    "0.000647676, 0.000654168, 0.000662052, 0.000670818, 0.000679914, "
    "0.000688791, 0.000696935, 0.000703911, 0.000709394, 0.000713203, "
    "0.000715327, 0.000715946, 0.000715441, 0.00071439,  0.000713537, "
    "0.000713747, 0.00071593,  0.000720953, 0.000729535, 0.000742155, "
    "0.000758969, 0.000779759, 0.000803929, 0.00083054,  0.000858408, "
    "0.00088622,  0.0009127,   0.000936759, 0.000957648, 0.000975065, "
    "0.00098921,  0.001000791, 0.001010952, 0.001021159, 0.00103304, "
    "0.001048209, 0.001068088, 0.001093761, 0.001125856, 0.001164499, "
    "0.001209302, 0.001259428, 0.001313679, 0.001370632, 0.001428785, "
    "0.001486697, 0.001543126, 0.001597132, 0.00164816,  0.001696075, "
    "0.001741178, 0.001784173, 0.001826119, 0.001868345, 0.00191235, "
    "0.001959682, 0.00201182,  0.002070035, 0.002135279, 0.002208074, "
    "0.002288442, 0.002375862, 0.002469283, 0.00256718,  0.002667668, "
    "0.002768659, 0.002868053, 0.00296395,  0.003054864, 0.003139902, "
    "0.0032189,   0.003292493, 0.003362094, 0.003429789, 0.003498146, "
    "0.00356995,  0.003647891, 0.003734243, 0.00383056,  0.003937432, "
    "0.004054343, 0.004179638, 0.004310629, 0.004443827, 0.00457528, "
    "0.004700994, 0.004817373, 0.00492164,  0.005012177, 0.005088745, "
    "0.005152544, 0.005206098, 0.005252985, 0.005297416, 0.005343738, "
    "0.005395892, 0.005456923, 0.005528571, 0.005611023, 0.005702849, "
    "0.005801121, 0.005901726, 0.005999812, 0.006090328, 0.006168582, "
    "0.006230758, 0.006274324, 0.00629828,  0.00630323,  0.006291265, "
    "0.006265674, 0.006230526, 0.006190181, 0.006148772, 0.006109744, "
    "0.00607548,  0.006047068, 0.006024226, 0.006005385, 0.005987919, "
    "0.005968486, 0.005943437, 0.005909246, 0.005862906, 0.005802254, "
    "0.005726192, 0.005634773, 0.005529164, 0.005411485, 0.005284556, "
    "0.005151578, 0.00501579,  0.004880148, 0.004747053, 0.004618158, "
    "0.004494276, 0.004375391, 0.004260762, 0.004149109, 0.004038846, "
    "0.003928344, 0.003816177, 0.003701341, 0.003583403, 0.003462588, "
    "0.003339778, 0.003216445, 0.003094507, 0.002976146, 0.002863593, "
    "0.002758912, 0.002663796, 0.002579408, 0.002506273, 0.002444239, "
    "0.002392511, 0.002349759, 0.002314285, 0.002284244, 0.002257883, "
    "0.002233783, 0.002211062, 0.002189526, 0.002169725, 0.002152917, "
    "0.002140926, 0.002135912, 0.002140067, 0.002155293, 0.002182888, "
    "0.002223286, 0.002275909, 0.002339138, 0.002410422, 0.002486524, "
    "0.002563864, 0.002638917, 0.002708617, 0.0027707,   0.002823948, "
    "0.002868281, 0.002904699, 0.002935076, 0.002961829, 0.00298753, "
    "0.003014495, 0.003044433, 0.003078187, 0.003115615, 0.003155616, "
    "0.003196291, 0.003235215, 0.003269769, 0.003297474, 0.003316298, "
    "0.00332487,  0.003322589, 0.003309629, 0.003286835, 0.003255554, "
    "0.003217429, 0.00317419,  0.003127483, 0.003078753, 0.003029189, "
    "0.002979734, 0.002931123, 0.002883952, 0.002838731, 0.002795918, "
    "0.002755909, 0.002719,    0.002685319, 0.002654758, 0.002626932, "
    "0.002601171, 0.002576583, 0.002552171, 0.002527008, 0.002500426, "
    "0.002472209, 0.002442726, 0.002412985, 0.002384573, 0.002359486, "
    "0.002339855, 0.002327601, 0.002324084, 0.002329793, 0.002344149, "
    "0.002365462, 0.002391071, 0.002417663, 0.002441725, 0.002460077, "
    "0.002470396, 0.002471629, 0.00246423,  0.002450153, 0.00243259, "
    "0.002415478, 0.002402849, 0.002398119, 0.002403444, 0.002419266, "
    "0.00244412,  0.002474775, 0.002506689, 0.002534709, 0.002553914, "
    "0.002560449, 0.002552205, 0.002529223, 0.002493728, 0.002449794, "
    "0.002402686, 0.00235799,  0.002320686, 0.002294334, 0.002280522, "
    "0.002278679, 0.002286271, 0.00229937,  0.002313447, 0.002324266, "
    "0.002328681, 0.0023252,   0.002314195, 0.002297722, 0.002279012, "
    "0.002261724, 0.002249127, 0.002243385, 0.002245097, 0.002253176, "
    "0.002265104, 0.002277494, 0.00228684,  0.002290281, 0.00228623, "
    "0.0022747,   0.002257282, 0.00223676,  0.002216456, 0.002199453, "
    "0.002187865, 0.002182325, 0.00218182,  0.002183902, 0.002185256, "
    "0.002182491, 0.002172994, 0.00215564,  0.002131208, 0.002102391, "
    "0.002073378, 0.002049084, 0.002034184, 0.002032137, 0.002044419, "
    "0.002070112, 0.002105963, 0.002146881, 0.00218681,  0.002219777, "
    "0.002240936, 0.002247385, 0.002238627, 0.002216573, 0.002185133, "
    "0.00214947,  0.002115097, 0.002086982, 0.002068836, 0.00206269, "
    "0.002068799, 0.002085835, 0.002111287, 0.00214193,  0.002174259, "
    "0.002204798, 0.002230268, 0.002247646, 0.002254184, 0.002247487, "
    "0.002225725, 0.002187976, 0.00213469,  0.002068126, 0.001992634, "
    "0.001914624, 0.001842101, 0.001783747, 0.001747637, 0.001739778, "
    "0.001762756, 0.00181478,  0.001889415, 0.001976139, 0.002061744, "
    "0.002132407, 0.002176083, 0.002184792, 0.00215633,  0.002095022, "
    "0.002011295, 0.001920056, 0.001838148, 0.001781307, 0.001761202, "
    "0.001783154, 0.001845007, 0.001937412, 0.002045517, 0.002151746, "
    "0.002239143, 0.0022946,   0.002311307, 0.002289923, 0.002238193, "
    "0.002169111, 0.002097988, 0.002039075, 0.002002464, 0.001991951, "
    "0.002004359, 0.002030473, 0.002057405, 0.002071871, 0.002063634, "
    "0.002028321, 0.001968918, 0.001895553, 0.001823521, 0.001769936, "
    "0.001749711, 0.001771755, 0.001836281, 0.001933912, 0.002046893, "
    "0.002152288, 0.002226567, 0.002250677, 0.002214506, 0.002119759, "
    "0.001980517, 0.001821254, 0.00167257,  0.001565422, 0.001524984, "
    "0.001565347, 0.00168621,  0.001872264, 0.00209551,  0.002320111, "
    "0.002508892, 0.002630231, 0.002664001, 0.002605395, 0.002465869, "
    "0.002271041, 0.002055942, 0.001858578, 0.001713053, 0.001643591, "
    "0.00166057,  0.001759253, 0.001921368, 0.002119069, 0.002320419, "
    "0.002495209, 0.002619989, 0.002681372, 0.002677128, 0.002615059, "
    "0.002510148, 0.002380768, 0.0022449,   0.002117201, 0.002007453, "
    "0.001920564, 0.001857838, 0.001818932, 0.001803765, 0.001813711, "
    "0.001851623, 0.001920655, 0.002022211, 0.002153655, 0.002306612, "
    "0.002466535, 0.002614011, 0.002727776, 0.00278897,  0.002785731, "
    "0.002717042, 0.002594749, 0.002443014, 0.002294975, 0.002187024, "
    "0.002151731, 0.002210824, 0.002369781, 0.002615363, 0.002916843, "
    "0.003230963, 0.003509786, 0.003709965, 0.003801496, 0.003774053, "
    "0.003639429, 0.003429368, 0.003189073, 0.002967652, 0.002807507, "
    "0.002735026, 0.002754756, 0.002848582, 0.002980379, 0.003105387, "
    "0.003182428, 0.003186302, 0.003117461, 0.003006448, 0.002911556, "
    "0.002909543, 0.003080775, 0.003491467, 0.004176574, 0.005127023, "
    "0.006284395, 0.007544823, 0.008772183, 0.009818717, 0.010549662, "
    "0.010867424, 0.010730657, 0.010164346, 0.009258541, 0.008155442, "
    "0.007026756, 0.006045171, 0.00535502,  0.00504753,  0.005145289, "
    "0.005598983, 0.006297136, 0.007087225, 0.007804327, 0.008302023, "
    "0.00847983]";
#pragma endregion

//unoMap CloudMie::inversedCDF4 = {};
//unoMap CloudMie::inversedCDF8 = {};
//unoMap CloudMie::inversedCDF9 = {};
//unoMap CloudMie::inversedCDFe = {};

#pragma region CDF
alglib::real_1d_array CloudMie::CDF =
    "[0, 0.01079138, 0.031630599, 0.061105135, 0.097273489, 0.137853644, "
    "0.180437492, 0.222706249, 0.262622795, 0.298580804, 0.329496968, "
    "0.354840524, 0.374602403, 0.38921366, 0.399428328, 0.406188794, "
    "0.410492141, 0.413273625, 0.415319197, 0.417213579, 0.419324625, "
    "0.421819595, 0.424705077, 0.427880208, 0.431192572, 0.434487531, "
    "0.43764445, 0.440596506, 0.443334185, 0.445895305, 0.448346329, "
    "0.450760468, 0.453197702, 0.455690649, 0.45823838, 0.460808402, "
    "0.463345311, 0.46578347, 0.468060601, 0.470129366, 0.471964783, "
    "0.473566455, 0.474955757, 0.476169159, 0.47724952, 0.478237427, "
    "0.479164394, 0.480049154, 0.480897511, 0.481705399, 0.48246414, "
    "0.483166542, 0.483812377, 0.484412049, 0.484987732, 0.485571817, "
    "0.486203097, 0.486921502, 0.487762458, 0.488751897, 0.489902751, "
    "0.491213398, 0.49266813, 0.494239343, 0.4958909, 0.497582003, 0.49927097, "
    "0.50091845, 0.502489855, 0.503957016, 0.505299198, 0.506503744, "
    "0.507566532, 0.508492372, 0.509295271, 0.509998409, 0.510633532, "
    "0.511239518, 0.511859939, 0.512539654, 0.513320666, 0.514237704, "
    "0.515314129, 0.516558807, 0.51796453, 0.519508319, 0.52115372, "
    "0.522854828, 0.524561527, 0.526225193, 0.527804041, 0.529267361, "
    "0.53059806, 0.531793234, 0.532862811, 0.533826626, 0.534710503, "
    "0.535542082, 0.536347051, 0.537146368, 0.537954796, 0.5387808, "
    "0.539627625, 0.540495137, 0.541381947, 0.542287298, 0.543212343, "
    "0.544160595, 0.545137521, 0.54614949, 0.547202366, 0.548300129, "
    "0.549443866, 0.55063138, 0.551857477, 0.553114886, 0.554395555, "
    "0.555692054, 0.556998735, 0.55831241, 0.559632388, 0.560959889, "
    "0.562296972, 0.563645229, 0.565004577, 0.566372422, 0.567743419, "
    "0.569109921, 0.570463049, 0.571794205, 0.573096716, 0.574367304, "
    "0.575607055, 0.576821692, 0.578021057, 0.579217864, 0.580425913, "
    "0.581658066, 0.582924317, 0.584230264, 0.585576229, 0.58695716, "
    "0.588363298, 0.589781491, 0.591196913, 0.592594928, 0.593962797, "
    "0.595291008, 0.596574064, 0.597810676, 0.599003398, 0.60015783, "
    "0.601281569, 0.602383088, 0.603470724, 0.604551898, 0.605632658, "
    "0.606717519, 0.607809604, 0.60891096, 0.610022991, 0.611146887, "
    "0.612283991, 0.613436029, 0.614605207, 0.615794134, 0.617005627, "
    "0.6182424, 0.619506677, 0.620799772, 0.622121685, 0.623470736, "
    "0.624843313, 0.626233769, 0.627634518, 0.629036371, 0.630429122, "
    "0.631802368, 0.633146513, 0.634453862, 0.635719686, 0.636943103, "
    "0.63812765, 0.639281402, 0.640416576, 0.6415486, 0.642694698, "
    "0.643872136, 0.645096295, 0.646378816, 0.64772605, 0.649138015, "
    "0.650608021, 0.65212305, 0.653664856, 0.655211705, 0.656740542, "
    "0.658229364, 0.659659511, 0.661017624, 0.66229704, 0.663498479, "
    "0.664629936, 0.665705812, 0.666745377, 0.66777075, 0.668804615, "
    "0.669867923, 0.670977821, 0.672146021, 0.673377768, 0.674671501, "
    "0.676019218, 0.677407505, 0.678819091, 0.680234762, 0.681635427, "
    "0.683004101, 0.684327618, 0.685597868, 0.686812449, 0.687974678, "
    "0.689092957, 0.690179597, 0.691249247, 0.692317112, 0.693397197, "
    "0.69450077, 0.695635241, 0.696803579, 0.698004318, 0.699232133, "
    "0.700478879, 0.701734945, 0.702990702, 0.704237861, 0.705470524, "
    "0.706685818, 0.707884008, 0.70906812, 0.710243131, 0.711414894, "
    "0.712588954, 0.713769475, 0.714958427, 0.716155179, 0.717356554, "
    "0.718557332, 0.719751118, 0.720931441, 0.72209289, 0.72323213, "
    "0.724348605, 0.725444834, 0.726526241, 0.72760053, 0.728676699, "
    "0.729763834, 0.730869844, 0.732000328, 0.733157733, 0.734340917, "
    "0.735545185, 0.736762783, 0.737983795, 0.739197317, 0.740392751, "
    "0.741561055, 0.742695792, 0.74379385, 0.744855755, 0.745885543, "
    "0.746890241, 0.747879005, 0.74886206, 0.74984956, 0.750850505, "
    "0.751871847, 0.752917862, 0.75398985, 0.755086171, 0.756202587, "
    "0.757332841, 0.758469406, 0.759604292, 0.760729823, 0.761839323, "
    "0.762927635, 0.76399145, 0.765029446, 0.766042245, 0.767032215, "
    "0.768003173, 0.768960001, 0.769908242, 0.770853682, 0.771801946, "
    "0.772758126, 0.773726448, 0.774709975, 0.775710388, 0.776727822, "
    "0.777760807, 0.778806312, 0.77985992, 0.78091613, 0.781968791, "
    "0.783011628, 0.784038831, 0.785045645, 0.786028898, 0.78698739, "
    "0.787922105, 0.788836177, 0.789734626, 0.790623855, 0.791510979, "
    "0.792403037, 0.793306207, 0.794225093, 0.795162204, 0.796117673, "
    "0.797089264, 0.798072671, 0.799062063, 0.800050806, 0.801032271, "
    "0.802000613, 0.802951432, 0.803882213, 0.80479252, 0.805683905, "
    "0.806559572, 0.807423849, 0.808281551, 0.809137331, 0.809995106, "
    "0.810857646, 0.811726353, 0.812601266, 0.813481256, 0.814364379, "
    "0.815248299, 0.816130719, 0.817009746, 0.817884125, 0.818753319, "
    "0.819617436, 0.820477018, 0.821332754, 0.82218517, 0.823034372, "
    "0.823879882, 0.82472062, 0.825555029, 0.826381335, 0.82719789, "
    "0.828003548, 0.82879799, 0.829581951, 0.830357282, 0.831126836, "
    "0.831894165, 0.832663086, 0.83343715, 0.834219107, 0.83501045, "
    "0.835811098, 0.836619297, 0.83743174, 0.838243923, 0.839050677, "
    "0.839846822, 0.840627844, 0.841390502, 0.84213329, 0.842856668, "
    "0.84356304, 0.844256474, 0.844942203, 0.845625966, 0.846313286, "
    "0.847008778, 0.847715585, 0.848435004, 0.849166361, 0.849907144, "
    "0.85065336, 0.851400081, 0.852142077, 0.852874477, 0.853593346, "
    "0.854296121, 0.854981851, 0.855651222, 0.856306374, 0.856950555, "
    "0.85758765, 0.858221683, 0.858856326, 0.859494505, 0.860138128, "
    "0.860787966, 0.861443681, 0.862103988, 0.862766908, 0.863430077, "
    "0.86409105, 0.864747584, 0.865397846, 0.86604054, 0.866674963, "
    "0.867300966, 0.867918882, 0.868529402, 0.869133452, 0.869732076, "
    "0.870326337, 0.870917251, 0.871505741, 0.872092617, 0.872678559, "
    "0.873264115, 0.873849678, 0.874435477, 0.875021544, 0.875607698, "
    "0.87619353, 0.876778408, 0.877361504, 0.877941848, 0.878518409, "
    "0.87909019, 0.87965633, 0.880216204, 0.880769497, 0.88131625, "
    "0.881856869, 0.882392085, 0.882922884, 0.883450404, 0.883975811, "
    "0.884500181, 0.885024391, 0.885549035, 0.886074378, 0.886600346, "
    "0.887126553, 0.887652363, 0.88817696, 0.888699447, 0.889218923, "
    "0.889734568, 0.890245695, 0.890751797, 0.891252567, 0.891747903, "
    "0.892237908, 0.892722876, 0.893203274, 0.893679717, 0.894152948, "
    "0.894623788, 0.895093099, 0.895561713, 0.896030365, 0.896499611, "
    "0.896969754, 0.897440782, 0.897912328, 0.898383674, 0.898853788, "
    "0.899321417, 0.899785211, 0.900243882, 0.900696361, 0.90114195, "
    "0.901580438, 0.902012153, 0.902437952, 0.902859139, 0.903277317, "
    "0.903694191, 0.904111353, 0.904530076, 0.904951142, 0.905374736, "
    "0.905800424, 0.90622721, 0.906653672, 0.90707816, 0.907499013, "
    "0.907914787, 0.908324436, 0.908727437, 0.909123845, 0.909514249, "
    "0.909899675, 0.91028142, 0.910660863, 0.911039278, 0.911417672, "
    "0.911796682, 0.912176519, 0.912556994, 0.912937589, 0.913317568, "
    "0.913696111, 0.914072435, 0.914445901, 0.914816073, 0.915182741, "
    "0.915545901, 0.915905707, 0.9162624, 0.916616243, 0.916967463, "
    "0.917316215, 0.917662579, 0.918006574, 0.918348196, 0.918687454, "
    "0.919024415, 0.919359222, 0.919692099, 0.92002333, 0.920353221, "
    "0.920682049, 0.921010002, 0.921337142, 0.921663371, 0.921988433, "
    "0.922311931, 0.922633376, 0.922952249, 0.923268072, 0.923580472, "
    "0.923889233, 0.924194332, 0.924495942, 0.924794414, 0.925090235, "
    "0.92538397, 0.925676197, 0.92596744, 0.926258114, 0.926548483, "
    "0.926838635, 0.927128481, 0.927417766, 0.927706109, 0.927993037, "
    "0.928278041, 0.928560628, 0.928840365, 0.929116928, 0.929390128, "
    "0.929659931, 0.929926461, 0.930189992, 0.930450917, 0.930709713, "
    "0.930966895, 0.93122296, 0.931478336, 0.93173334, 0.931988137, "
    "0.932242727, 0.93249694, 0.932750458, 0.933002848, 0.933253618, "
    "0.933502271, 0.933748364, 0.93399156, 0.93423167, 0.934468669, "
    "0.934702696, 0.934934039, 0.93516309, 0.935390302, 0.935616131, "
    "0.935840983, 0.936065173, 0.936288893, 0.936512199, 0.936735017, "
    "0.93695716, 0.93717836, 0.937398305, 0.937616679, 0.937833197, "
    "0.938047634, 0.938259841, 0.938469754, 0.938677393, 0.938882848, "
    "0.939086266, 0.939287832, 0.939487745, 0.939686206, 0.939883398, "
    "0.940079472, 0.940274546, 0.940468691, 0.940661933, 0.940854256, "
    "0.9410456, 0.941235871, 0.941424951, 0.941612707, 0.941799005, "
    "0.941983721, 0.942166758, 0.942348053, 0.942527581, 0.942705367, "
    "0.942881471, 0.943055991, 0.943229046, 0.943400765, 0.943571272, "
    "0.943740674, 0.943909052, 0.944076457, 0.944242904, 0.944408384, "
    "0.944572863, 0.944736295, 0.944898629, 0.945059815, 0.94521981, "
    "0.94537858, 0.945536099, 0.945692345, 0.945847298, 0.946000941, "
    "0.946153256, 0.946304228, 0.946453848, 0.946602122, 0.946749072, "
    "0.946894743, 0.947039206, 0.947182551, 0.947324883, 0.94746631, "
    "0.947606932, 0.947746822, 0.947886019, 0.948024517, 0.948162264, "
    "0.948299162, 0.948435081, 0.948569875, 0.948703397, 0.948835523, "
    "0.94896617, 0.949095305, 0.949222958, 0.949349213, 0.949474206, "
    "0.949598106, 0.949721093, 0.949843338, 0.949964985, 0.950086128, "
    "0.950206804, 0.950326992, 0.950446614, 0.950565548, 0.950683648, "
    "0.950800763, 0.950916755, 0.951031519, 0.951144997, 0.951257182, "
    "0.951368117, 0.95147789, 0.951586619, 0.951694436, 0.951801469, "
    "0.951907829, 0.952013592, 0.952118795, 0.952223437, 0.952327479, "
    "0.952430857, 0.952533495, 0.952635319, 0.952736267, 0.952836304, "
    "0.952935421, 0.953033639, 0.953131, 0.953227558, 0.953323368, "
    "0.953418474, 0.9535129, 0.953606644, 0.953699682, 0.953791967, "
    "0.953883448, 0.953974074, 0.954063813, 0.954152659, 0.954240639, "
    "0.954327814, 0.954414269, 0.954500104, 0.954585419, 0.954670292, "
    "0.954754772, 0.954838862, 0.954922521, 0.955005666, 0.955088187, "
    "0.955169959, 0.955250868, 0.955330828, 0.955409796, 0.95548778, "
    "0.955564842, 0.955641086, 0.955716648, 0.95579167, 0.95586628, "
    "0.955940578, 0.956014614, 0.95608839, 0.956161857, 0.956234928, "
    "0.956307494, 0.956379445, 0.956450686, 0.956521152, 0.956590819, "
    "0.956659703, 0.956727858, 0.95679536, 0.956862292, 0.956928736, "
    "0.95699475, 0.957060368, 0.957125596, 0.957190412, 0.95725478, "
    "0.957318658, 0.957382012, 0.957444822, 0.957507087, 0.95756883, "
    "0.957630087, 0.957690902, 0.957751316, 0.957811358, 0.957871034, "
    "0.957930331, 0.95798921, 0.958047621, 0.958105509, 0.958162822, "
    "0.958219529, 0.958275622, 0.958331118, 0.958386063, 0.958440521, "
    "0.958494567, 0.958548272, 0.958601696, 0.958654877, 0.958707824, "
    "0.958760522, 0.958812933, 0.958865002, 0.958916669, 0.958967879, "
    "0.959018588, 0.95906877, 0.959118418, 0.959167545, 0.959216177, "
    "0.959264348, 0.959312096, 0.959359452, 0.959406442, 0.959453084, "
    "0.959499387, 0.959545353, 0.959590983, 0.959636278, 0.959681242, "
    "0.959725883, 0.959770209, 0.959814232, 0.959857958, 0.959901388, "
    "0.959944517, 0.959987327, 0.960029797, 0.960071899, 0.960113602, "
    "0.960154883, 0.960195726, 0.960236129, 0.960276105, 0.960315682, "
    "0.960354901, 0.960393812, 0.960432467, 0.960470918, 0.960509204, "
    "0.960547352, 0.960585372, 0.960623256, 0.960660978, 0.960698502, "
    "0.96073578, 0.960772766, 0.960809417, 0.960845701, 0.960881599, "
    "0.960917113, 0.960952259, 0.960987072, 0.961021596, 0.961055883, "
    "0.961089986, 0.961123951, 0.961157812, 0.96119159, 0.961225287, "
    "0.961258889, 0.96129237, 0.961325692, 0.961358816, 0.961391703, "
    "0.961424326, 0.961456665, 0.961488719, 0.961520498, 0.961552025, "
    "0.961583329, 0.961614443, 0.961645395, 0.961676205, 0.961706882, "
    "0.961737422, 0.961767808, 0.961798018, 0.961828023, 0.961857797, "
    "0.961887321, 0.961916589, 0.961945604, 0.961974386, 0.962002963, "
    "0.96203137, 0.962059639, 0.962087801, 0.96211587, 0.962143849, "
    "0.962171722, 0.962199459, 0.962227019, 0.962254356, 0.962281427, "
    "0.962308196, 0.962334645, 0.962360774, 0.962386604, 0.962412172, "
    "0.962437532, 0.962462742, 0.962487859, 0.962512932, 0.96253799, "
    "0.962563046, 0.962588089, 0.962613088, 0.962637998, 0.962662765, "
    "0.962687337, 0.962711671, 0.962735736, 0.962759524, 0.962783045, "
    "0.962806326, 0.962829409, 0.962852344, 0.962875178, 0.962897953, "
    "0.962920697, 0.962943424, 0.962966133, 0.962988811, 0.963011434, "
    "0.963033978, 0.963056419, 0.963078741, 0.963100936, 0.963123003, "
    "0.963144951, 0.963166791, 0.963188535, 0.963210193, 0.963231767, "
    "0.963253253, 0.963274642, 0.963295921, 0.963317078, 0.963338105, "
    "0.963359, 0.963379772, 0.963400437, 0.963421019, 0.963441543, "
    "0.963462035, 0.963482515, 0.963502991, 0.963523463, 0.963543918, "
    "0.963564333, 0.963584679, 0.963604928, 0.963625054, 0.963645037, "
    "0.96366487, 0.963684554, 0.963704101, 0.96372353, 0.963742864, "
    "0.963762126, 0.963781335, 0.963800507, 0.96381965, 0.963838769, "
    "0.963857862, 0.963876925, 0.963895956, 0.96391495, 0.963933904, "
    "0.963952817, 0.963971688, 0.963990517, 0.9640093, 0.964028035, "
    "0.964046715, 0.964065338, 0.964083897, 0.964102393, 0.964120825, "
    "0.9641392, 0.964157524, 0.964175807, 0.96419406, 0.964212292, 0.96423051, "
    "0.964248717, 0.964266914, 0.964285099, 0.96430327, 0.964321425, "
    "0.964339567, 0.964357697, 0.964375824, 0.964393953, 0.964412089, "
    "0.964430235, 0.964448386, 0.964466531, 0.964484652, 0.964502725, "
    "0.964520726, 0.964538633, 0.964556432, 0.964574118, 0.964591697, "
    "0.964609189, 0.964626622, 0.96464403, 0.964661447, 0.9646789, "
    "0.964696405, 0.964713965, 0.964731566, 0.964749181, 0.964766776, "
    "0.96478431, 0.964801746, 0.964819054, 0.964836218, 0.964853235, "
    "0.964870115, 0.964886881, 0.96490356, 0.964920183, 0.964936775, "
    "0.964953355, 0.964969934, 0.964986511, 0.965003078, 0.965019623, "
    "0.96503613, 0.965052587, 0.965068985, 0.965085319, 0.965101593, "
    "0.965117813, 0.965133987, 0.965150124, 0.965166233, 0.965182321, "
    "0.965198391, 0.965214444, 0.965230483, 0.965246506, 0.965262518, "
    "0.965278519, 0.965294513, 0.965310506, 0.9653265, 0.965342498, "
    "0.965358502, 0.965374513, 0.965390532, 0.965406564, 0.965422616, "
    "0.965438702, 0.965454837, 0.965471045, 0.965487348, 0.965503765, "
    "0.965520312, 0.965536995, 0.965553807, 0.965570734, 0.965587746, "
    "0.965604813, 0.9656219, 0.965638981, 0.96565604, 0.965673076, "
    "0.965690107, 0.965707167, 0.965724301, 0.965741562, 0.965758999, "
    "0.965776652, 0.965794542, 0.965812671, 0.965831019, 0.965849547, "
    "0.965868202, 0.96588693, 0.965905678, 0.965924409, 0.965943104, "
    "0.965961765, 0.965980416, 0.965999097, 0.966017853, 0.966036732, "
    "0.966055771, 0.966074991, 0.966094392, 0.966113954, 0.966133641, "
    "0.966153406, 0.9661732, 0.966192979, 0.966212713, 0.966232388, "
    "0.966252009, 0.966271597, 0.966291184, 0.966310803, 0.966330484, "
    "0.966350245, 0.966370088, 0.966389996, 0.966409939, 0.966429873, "
    "0.966449751, 0.966469531, 0.966489177, 0.966508673, 0.966528018, "
    "0.966547228, 0.966566331, 0.966585363, 0.966604361, 0.966623353, "
    "0.966642354, 0.966661366, 0.966680373, 0.966699345, 0.966718244, "
    "0.966737027, 0.966755655, 0.966774097, 0.966792336, 0.966810368, "
    "0.966828207, 0.966845875, 0.966863406, 0.966880836, 0.966898197, "
    "0.966915517, 0.966932812, 0.966950088, 0.966967337, 0.966984542, "
    "0.967001679, 0.967018721, 0.967035642, 0.967052422, 0.96706905, "
    "0.967085528, 0.967101869, 0.967118096, 0.967134244, 0.967150351, "
    "0.967166456, 0.967182595, 0.967198794, 0.967215069, 0.967231424, "
    "0.967247849, 0.967264325, 0.967280829, 0.967297337, 0.967313831, "
    "0.967330302, 0.967346755, 0.967363211, 0.967379701, 0.967396267, "
    "0.967412955, 0.967429807, 0.967446859, 0.967464137, 0.967481649, "
    "0.967499394, 0.96751736, 0.967535529, 0.967553884, 0.967572414, "
    "0.967591117, 0.967609999, 0.967629078, 0.967648379, 0.967667927, "
    "0.967687747, 0.967707854, 0.967728258, 0.967748959, 0.967769953, "
    "0.967791233, 0.967812798, 0.967834653, 0.967856815, 0.96787931, "
    "0.967902169, 0.967925424, 0.9679491, 0.967973208, 0.967997738, "
    "0.968022664, 0.968047938, 0.968073505, 0.968099309, 0.968125304, "
    "0.968151466, 0.968177801, 0.968204342, 0.968231152, 0.968258309, "
    "0.968285895, 0.968313981, 0.968342612, 0.968371796, 0.968401501, "
    "0.968431659, 0.968462174, 0.968492939, 0.968523852, 0.968554837, "
    "0.968585852, 0.968616901, 0.96864803, 0.968679316, 0.968710858, "
    "0.968742754, 0.968775084, 0.968807895, 0.968841195, 0.968874949, "
    "0.968909087, 0.968943519, 0.96897815, 0.969012895, 0.969047697, "
    "0.96908253, 0.969117405, 0.969152362, 0.96918746, 0.969222762, "
    "0.969258324, 0.969294181, 0.969330342, 0.969366791, 0.96940349, "
    "0.969440391, 0.969477444, 0.969514608, 0.969551859, 0.96958919, "
    "0.96962661, 0.969664136, 0.969701786, 0.969739565, 0.969777463, "
    "0.96981545, 0.969853476, 0.969891484, 0.969929415, 0.969967222, "
    "0.970004882, 0.970042398, 0.970079804, 0.97011716, 0.970154536, "
    "0.970192005, 0.97022962, 0.970267409, 0.970305357, 0.970343411, "
    "0.970381483, 0.970419459, 0.970457218, 0.970494648, 0.970531665, "
    "0.970568222, 0.970604318, 0.970639996, 0.970675337, 0.970710441, "
    "0.970745416, 0.970780359, 0.970815343, 0.970850404, 0.97088554, "
    "0.970920716, 0.970955867, 0.970990913, 0.971025773, 0.971060373, "
    "0.971094661, 0.971128605, 0.971162203, 0.971195468, 0.971228433, "
    "0.971261134, 0.971293608, 0.971325881, 0.971357972, 0.971389886, "
    "0.971421619, 0.971453161, 0.971484503, 0.971515638, 0.971546568, "
    "0.971577303, 0.971607859, 0.971638256, 0.971668512, 0.971698639, "
    "0.971728638, 0.971758497, 0.971788187, 0.97181767, 0.971846899, "
    "0.971875827, 0.971904414, 0.971932632, 0.971960471, 0.971987945, "
    "0.972015087, 0.972041949, 0.972068595, 0.972095093, 0.972121507, "
    "0.972147889, 0.972174272, 0.972200665, 0.972227055, 0.972253408, "
    "0.972279674, 0.972305794, 0.972331711, 0.972357377, 0.97238276, "
    "0.972407851, 0.972432663, 0.972457236, 0.972481628, 0.972505913, "
    "0.972530174, 0.972554496, 0.972578958, 0.972603627, 0.972628556, "
    "0.972653776, 0.972679298, 0.972705114, 0.972731195, 0.972757495, "
    "0.972783959, 0.972810524, 0.972837126, 0.97286371, 0.972890232, "
    "0.972916674, 0.972943042, 0.972969377, 0.972995749, 0.973022264, "
    "0.973049051, 0.973076258, 0.973104035, 0.973132527, 0.973161854, "
    "0.973192102, 0.973223313, 0.973255482, 0.973288557, 0.973322448, "
    "0.973357036, 0.973392194, 0.973427803, 0.973463768, 0.973500037, "
    "0.97353661, 0.973573545, 0.973610959, 0.973649017, 0.973687923, "
    "0.973727902, 0.973769181, 0.973811973, 0.973856461, 0.973902784, "
    "0.973951029, 0.974001233, 0.974053379, 0.974107408, 0.974163229, "
    "0.974220729, 0.974279795, 0.974340323, 0.974402233, 0.974465485, "
    "0.974530081, 0.974596078, 0.974663585, 0.974732761, 0.974803807, "
    "0.974876956, 0.974952458, 0.975030563, 0.975111499, 0.975195459, "
    "0.975282583, 0.975372946, 0.975466551, 0.975563332, 0.975663158, "
    "0.975765848, 0.975871194, 0.975978982, 0.976089021, 0.976201167, "
    "0.976315349, 0.976431579, 0.976549961, 0.97667069, 0.976794031, "
    "0.976920303, 0.977049838, 0.977182953, 0.977319905, 0.977460865, "
    "0.977605885, 0.977754893, 0.977907682, 0.978063934, 0.978223241, "
    "0.978385144, 0.978549181, 0.97871493, 0.978882054, 0.979050332, "
    "0.979219678, 0.979390145, 0.979561913, 0.979735257, 0.979910503, "
    "0.980087982, 0.98026798, 0.980450687, 0.98063616, 0.980824308, "
    "0.981014879, 0.981207477, 0.981401592, 0.981596634, 0.98179199, "
    "0.981987067, 0.982181342, 0.982374396, 0.982565938, 0.982755813, "
    "0.982943994, 0.983130558, 0.983315655, 0.983499467, 0.983682166, "
    "0.983863877, 0.984044642, 0.984224404, 0.984402996, 0.984580148, "
    "0.9847555, 0.984928631, 0.98509909, 0.985266433, 0.985430249, "
    "0.985590198, 0.985746023, 0.985897562, 0.986044753, 0.986187617, "
    "0.986326249, 0.986460789, 0.9865914, 0.986718245, 0.986841463, "
    "0.986961156, 0.987077379, 0.987190141, 0.98729941, 0.987405125, "
    "0.987507214, 0.987605613, 0.987700281, 0.987791221, 0.987878491, "
    "0.987962207, 0.988042551, 0.988119758, 0.98819411, 0.98826592, "
    "0.988335512, 0.988403203, 0.988469287, 0.98853402, 0.988597606, "
    "0.9886602, 0.988721907, 0.988782791, 0.988842894, 0.988902252, "
    "0.988960913, 0.989018962, 0.98907653, 0.989133806, 0.989191036, "
    "0.989248514, 0.989306567, 0.989365529, 0.989425719, 0.989487408, "
    "0.989550797, 0.989616003, 0.989683046, 0.989751855, 0.989822279, "
    "0.989894111, 0.989967112, 0.990041045, 0.990115699, 0.990190913, "
    "0.990266591, 0.990342702, 0.990419272, 0.990496375, 0.990574099, "
    "0.990652534, 0.990731737, 0.99081172, 0.990892431, 0.990973756, "
    "0.99105552, 0.991137499, 0.991219437, 0.991301065, 0.991382123, "
    "0.991462371, 0.991541608, 0.991619671, 0.991696442, 0.991771844, "
    "0.991845835, 0.991918403, 0.991989558, 0.992059326, 0.99212775, "
    "0.992194883, 0.992260787, 0.992325536, 0.992389207, 0.992451882, "
    "0.992513639, 0.992574545, 0.992634652, 0.992693991, 0.99275257, "
    "0.992810375, 0.992867378, 0.992923546, 0.992978854, 0.993033301, "
    "0.99308692, 0.993139792, 0.993192041, 0.993243835, 0.993295368, "
    "0.993346845, 0.993398456, 0.993450351, 0.993502619, 0.993555279, "
    "0.993608272, 0.993661469, 0.993714694, 0.993767752, 0.993820456, "
    "0.993872666, 0.993924309, 0.993975398, 0.994026029, 0.994076371, "
    "0.994126634, 0.994177036, 0.99422776, 0.994278925, 0.994330549, "
    "0.994382548, 0.994434738, 0.994486857, 0.994538604, 0.994589683, "
    "0.994639845, 0.994688928, 0.994736875, 0.99478374, 0.994829679, "
    "0.994874911, 0.994919689, 0.994964247, 0.995008769, 0.995053362, "
    "0.995098041, 0.995142741, 0.995187339, 0.995231682, 0.995275628, "
    "0.995319075, 0.995361984, 0.995404385, 0.995446367, 0.99548806, "
    "0.995529603, 0.995571113, 0.995612659, 0.995654248, 0.995695821, "
    "0.99573727, 0.99577846, 0.995819257, 0.995859557, 0.995899308, "
    "0.995938517, 0.995977245, 0.99601559, 0.996053659, 0.996091541, "
    "0.99612928, 0.996166864, 0.996204221, 0.996241236, 0.99627778, "
    "0.996313734, 0.996349028, 0.996383666, 0.996417728, 0.996451375, "
    "0.996484821, 0.996518299, 0.996552028, 0.996586167, 0.996620791, "
    "0.996655878, 0.996691311, 0.996726895, 0.996762396, 0.996797573, "
    "0.996832219, 0.996866192, 0.996899433, 0.996931967, 0.996963895, "
    "0.996995373, 0.997026587, 0.997057721, 0.997088937, 0.997120358, "
    "0.997152057, 0.997184052, 0.997216312, 0.997248759, 0.99728127, "
    "0.997313687, 0.99734582, 0.997377455, 0.99740837, 0.997438354, "
    "0.997467229, 0.997494884, 0.997521295, 0.997546551, 0.997570858, "
    "0.997594525, 0.997617939, 0.997641515, 0.997665633, 0.997690584, "
    "0.997716513, 0.997743392, 0.997771012, 0.997799015, 0.997826945, "
    "0.997854329, 0.997880758, 0.99790596, 0.997929857, 0.997952579, "
    "0.997974447, 0.99799592, 0.998017509, 0.99803969, 0.998062818, "
    "0.998087064, 0.998112385, 0.998138545, 0.998165157, 0.998191767, "
    "0.998217935, 0.998243322, 0.99826774, 0.998291178, 0.998313785, "
    "0.998335816, 0.998357561, 0.998379271, 0.998401091, 0.998423026, "
    "0.998444938, 0.998466587, 0.998487692, 0.998508011, 0.998527411, "
    "0.998545917, 0.998563728, 0.998581185, 0.998598711, 0.998616717, "
    "0.998635515, 0.998655237, 0.998675789, 0.998696861, 0.998717967, "
    "0.998738545, 0.99875806, 0.998776124, 0.998792578, 0.998807545, "
    "0.998821419, 0.998834802, 0.998848405, 0.998862914, 0.998878861, "
    "0.99889653, 0.998915893, 0.998936615, 0.998958113, 0.998979658, "
    "0.999000503, 0.99902002, 0.999037799, 0.999053716, 0.999067946, "
    "0.999080913, 0.999093213, 0.999105497, 0.999118359, 0.99913224, "
    "0.999147367, 0.99916373, 0.999181109, 0.99919913, 0.999217342, "
    "0.999235292, 0.9992526, 0.999268996, 0.99928434, 0.999298615, "
    "0.999311894, 0.999324312, 0.999336026, 0.999347197, 0.999357976, "
    "0.999368509, 0.999378942, 0.999389433, 0.999400147, 0.999411252, "
    "0.999422892, 0.999435158, 0.99944806, 0.999461506, 0.999475301, "
    "0.999489163, 0.999502767, 0.999515799, 0.999528019, 0.999539313, "
    "0.999549722, 0.999559452, 0.999568837, 0.999578288, 0.999588212, "
    "0.999598937, 0.999610644, 0.999623331, 0.999636807, 0.999650728, "
    "0.999664661, 0.999678165, 0.999690869, 0.999702542, 0.999713118, "
    "0.9997227, 0.999731522, 0.999739877, 0.999748052, 0.999756258, "
    "0.999764585, 0.99977299, 0.999781326, 0.999789394, 0.999797017, "
    "0.999804105, 0.999810715, 0.999817066, 0.999823522, 0.999830533, "
    "0.999838556, 0.999847957, 0.999858932, 0.99987145, 0.999885239, "
    "0.999899816, 0.999914557, 0.999928794, 0.999941915, 0.999953457, "
    "0.999963161, 0.999970996, 0.999977134, 0.999981886, 0.999985627, "
    "0.999988713, 0.99999141, 0.999993855, 0.999996055, 0.999997912, "
    "0.999999275, 0.99999999, 1]";
#pragma, endregion

// Media Definitions
PhaseFunction::~PhaseFunction() {}

bool GetMediumScatteringProperties(const std::string &name, Spectrum *sigma_a,
                                   Spectrum *sigma_prime_s) {
    for (MeasuredSS &mss : SubsurfaceParameterTable) {
        if (name == mss.name) {
            *sigma_a = Spectrum::FromRGB(mss.sigma_a);
            *sigma_prime_s = Spectrum::FromRGB(mss.sigma_prime_s);
            return true;
        }
    }
    return false;
}

// HenyeyGreenstein Method Definitions
Float HenyeyGreenstein::Sample_p(const Vector3f &wo, Vector3f *wi,
                                 const Point2f &u) const {
    ProfilePhase _(Prof::PhaseFuncSampling);
    // Compute $\cos \theta$ for Henyey--Greenstein sample
    Float cosTheta;
    if (std::abs(g) < 1e-3)
        cosTheta = 1 - 2 * u[0];
    else {
        Float sqrTerm = (1 - g * g) / (1 - g + 2 * g * u[0]);
        cosTheta = (1 + g * g - sqrTerm * sqrTerm) / (2 * g);
    }

    // Compute direction _wi_ for Henyey--Greenstein sample
    Float sinTheta = std::sqrt(std::max((Float)0, 1 - cosTheta * cosTheta));
    Float phi = 2 * Pi * u[1];
    Vector3f v1, v2;
    CoordinateSystem(wo, &v1, &v2);
    *wi = SphericalDirection(sinTheta, cosTheta, phi, v1, v2, -wo);
    return PhaseHG(-cosTheta, g);
}

Float HenyeyGreenstein::p(const Vector3f &wo, const Vector3f &wi) const {
    ProfilePhase _(Prof::PhaseFuncEvaluation);
    return PhaseHG(Dot(wo, wi), g);
}

// WZR:

void CloudMie::createCerp() {    
    alglib::spline1dbuildcubic(CDF, Theta, CerpInv);
    alglib::spline1dbuildcubic(Theta, MiePhase, CerpPhase);
}


//void CloudMie::initializeCDF() {
//    // 0 to 0.4
//    for (int i = 0; i < 16; i++) {
//        int x = int(round(CDF[i] * 1000));
//        Float y = i / 10.0;
//        inversedCDF4.insert(std::make_pair(x, y));
//    }
//    // 0.4 to 0.8
//    for (int i = 14; i < 326; i++) {
//        int x = int(round(CDF[i] * 10000));
//        Float y = i / 10.0;
//        inversedCDF8.insert(std::make_pair(x, y));
//    }
//    // 0.8 to 0.9560
//    for (int i = 324; i < 729; i++) {
//        int x = int(round(CDF[i] * 10000));
//        Float y = i / 10.0;
//        inversedCDF9.insert(std::make_pair(x, y));
//    }
//    // greater than 0.9560
//    for (int i = 727; i < 1801; i++) {
//        int x = int(round(CDF[i] * 100000));
//        Float y = i / 10.0;
//        inversedCDFe.insert(std::make_pair(x, y));
//    }
//}

//Float CloudMie::evaluate(Float u0, Float pre, unoMap &inversedCDF, Float r1,
//                         Float r2) const {
//    Float theta, t;
//    // round to precision pre
//    int m = int(round(u0 / pre));
//    int l = m;
//    int r = m;
//    auto it = inversedCDF.find(m);
//    if (it != inversedCDF.end()) {
//        theta = it->second;
//    } else {
//        unoMap::iterator lIt;
//        unoMap::iterator rIt;
//
//        while (l >= r1) {
//            --l;
//            lIt = inversedCDF.find(l);
//            if (lIt != inversedCDF.end()) break;
//        }
//        if (l < r1) ++l;
//
//        while (r <= r2) {
//            ++r;
//            rIt = inversedCDF.find(r);
//            if (rIt != inversedCDF.end()) break;
//        }
//        if (r > r2) --r;
//
//        t = Float(m - l) / Float(r - l);
//        theta = Lerp(t, lIt->second, rIt->second);
//    }
//    return theta;
//}

Float CloudMie::Sample_p(const Vector3f &wo, Vector3f *wi,
                         const Point2f &u) const {
    ProfilePhase _(Prof::PhaseFuncSampling);
    // Compute theta for Mie sample
    Float theta, cosTheta, sinTheta, phi;
    // Float y1, y2, x1, x2, t;

    theta = alglib::spline1dcalc(CerpInv, u[0]);
    //evaluate theta from discrete inversed cdf with optimization on precision
    //if (u[0] < 0.400) {
    //    theta = evaluate(u[0], 0.001, inversedCDF4, 0, 407);
    //} else if (u[0] < 0.8000) {
    //    theta = evaluate(u[0], 0.0001, inversedCDF8, 3990, 8020);
    //} else if (u[0] < 0.9560) {
    //    theta = evaluate(u[0], 0.0001, inversedCDF9, 7991, 9560);
    //} else {
    //    theta = evaluate(u[0], 0.00001, inversedCDFe, 95594, 100000);
    //}

    /*
    auto it = inversedCDF.find(round(u[0] * 100) / 100);
    if (it != inversedCDF.end())
        theta = it->second;
    else {
        auto itY1 = std::upper_bound(CDF.begin(), CDF.end(), u[0]);
        if (itY1 == CDF.end())
            theta = 180.0;
        else {
            // less than theta
            auto itY2 = --itY1;
            y1 = *itY1;
            y2 = *itY2;
            // works as an inversed function
            x1 = std::distance(CDF.begin(), itY1);
            x2 = std::distance(CDF.begin(), itY2);
            // make sure y1 != y2
            if (y2 - y1 > 10e-4) {
                t = (u[0] - y1) / y2 - y1;
                // indices go from 0 to 1800
                theta = Lerp(t, x1, x2) / 10.0;
            } else
                theta = x1 / 10.0;
        }
    }
    */

    cosTheta = std::cos(ToRad(theta));
    // Compute direction _wi_ for Henyey--Greenstein sample
    sinTheta = std::sin(ToRad(theta));
    phi = 2 * Pi * u[1];
    Vector3f v1, v2;
    CoordinateSystem(wo, &v1, &v2);
    *wi = SphericalDirection(sinTheta, cosTheta, phi, v1, v2, -wo);
    return phaseMie(theta);
}

Float CloudMie::p(const Vector3f &wo, const Vector3f &wi) const {
    ProfilePhase _(Prof::PhaseFuncEvaluation);
    Float degree = ToDegrees(BetterAcos(Dot(wo, wi)));
    return phaseMie(degree);
}

Float CloudMie::phaseMie(Float degree) const {
    
    //Float degreeBy10 = degree * 10;
    //CHECK(degreeBy10 >= 0) << "<0";
    //CHECK(degreeBy10 <= 1800) << ">1800";
    //Float f1 = MiePhase[int(degreeBy10)];
    //Float t = degreeBy10 - int(degreeBy10);
    //Float f2 = MiePhase[int(degreeBy10) + 1];
    //return Lerp(t, f1, f2);
    
    return alglib::spline1dcalc(CerpPhase, degree);
}
}  // namespace pbrt